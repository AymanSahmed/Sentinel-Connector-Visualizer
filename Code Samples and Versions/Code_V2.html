<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Sentinel Solution Dependency Visualizer</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>

<!-- ===================== SECTION 1: STYLES ===================== -->
<style>
body { font-family: Inter, system-ui, sans-serif; background:#f7f7f7; }
.container { max-width:1720px; }
#visualization-container { border:2px solid #e5e7eb; background:#fff; border-radius:12px; box-shadow:0 10px 15px rgba(0,0,0,0.08); position:relative; overflow:hidden; }
.node-group rect { transition: all .18s; }
.node-group:hover rect { transform:scale(1.03); box-shadow:0 4px 10px rgba(0,0,0,.25); }
.graph-link { transition: stroke-width .18s, stroke-opacity .18s; }
.graph-link:hover { stroke-width:3; stroke-opacity:1; }
#tooltip { pointer-events:none; min-width:200px; max-width:380px; z-index:50; }
.badge { font-size:.60rem; letter-spacing:.5px; font-weight:600; text-transform:uppercase; padding:2px 6px; border-radius:6px; background:#eef2ff; color:#4338ca; }
.mechanism-badge { font-size:.55rem; font-weight:600; background:#1e293b; color:#f1f5f9; padding:2px 5px; border-radius:4px; letter-spacing:.5px; }
.status-log { max-height:150px; overflow:auto; font-size:.60rem; line-height:.95rem; }
.status-log::-webkit-scrollbar { width:6px; }
.status-log::-webkit-scrollbar-thumb { background:#94a3b8; border-radius:3px; }
.fade-enter { animation:fadeIn .25s ease-out; }
@keyframes fadeIn { from {opacity:0; transform:translateY(4px);} to {opacity:1; transform:translateY(0);} }
.legend-item { display:flex; align-items:center; gap:6px; font-size:.65rem; }
.legend-swatch { width:14px; height:14px; border-radius:3px; border:1px solid #1e293b33; }
.zoom-controls { position:absolute; top:10px; right:10px; display:flex; flex-direction:column; gap:6px; z-index:40; }
.zoom-controls button { background:#1e293b; color:#fff; width:34px; height:34px; border-radius:8px; font-weight:600; font-size:16px; line-height:16px; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 4px rgba(0,0,0,.25); }
.zoom-controls button:hover { background:#334155; }
.floating-controls { position:absolute; bottom:10px; left:10px; display:flex; gap:8px; align-items:center; background:#ffffffdd; padding:6px 10px; border-radius:10px; backdrop-filter:blur(4px); box-shadow:0 4px 12px rgba(0,0,0,0.12); z-index:30; }
.floating-controls button { font-size:.65rem; font-weight:600; background:#e2e8f0; padding:4px 8px; border-radius:6px; }
.floating-controls button:hover { background:#cbd5e1; }
.edge-type-label { font-size:.5rem; fill:#334155; pointer-events:none; }
</style>
</head>
<body class="p-4 md:p-6">

<!-- ===================== SECTION 2: HTML STRUCTURE ===================== -->
<div class="container mx-auto space-y-6">
  <header class="text-center space-y-1">
    <h1 class="text-3xl font-bold text-gray-800">Sentinel Solution Dependency Visualizer</h1>
    <p id="status" class="text-sm text-gray-600">Enter repository info and load solutions.</p>
  </header>

  <!-- Top Controls -->
  <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
    <div class="md:col-span-2">
      <label class="block text-xs font-semibold text-gray-600 uppercase">GitHub Repo (owner/repo)</label>
      <input id="repoInput" value="Azure/Azure-Sentinel" class="mt-1 w-full p-2 border rounded-md text-sm focus:ring-blue-500 focus:border-blue-500" />
    </div>
    <div>
      <label class="block text-xs font-semibold text-gray-600 uppercase">Branch</label>
      <input id="branchInput" value="master" class="mt-1 w-full p-2 border rounded-md text-sm focus:ring-blue-500 focus:border-blue-500" />
    </div>
    <div>
      <label class="block text-xs font-semibold text-gray-600 uppercase">GitHub PAT (Optional)</label>
      <input id="tokenInput" type="password" placeholder="Token" class="mt-1 w-full p-2 border rounded-md text-sm focus:ring-blue-500 focus:border-blue-500" />
    </div>
    <button id="btnLoad" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md text-sm">Load Solutions</button>
    <div class="flex gap-2">
      <button id="btnViz" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md text-sm">Visualize</button>
      <button id="btnReset" class="flex-1 bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md text-sm">Reset</button>
    </div>
  </div>

  <div class="grid grid-cols-1 xl:grid-cols-5 gap-6">
    <aside class="xl:col-span-1 space-y-6">
      <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 space-y-6">
        <div>
          <h3 class="text-sm font-semibold mb-2 border-b pb-1">Select Solution</h3>
            <select id="solutionSelect" class="w-full p-2 border rounded-md text-sm">
              <option value="">(Load solutions first)</option>
            </select>
          <div class="mt-3 flex items-center gap-2 text-xs">
            <input id="includeNonCore" type="checkbox" class="h-4 w-4" checked />
            <label for="includeNonCore" class="text-gray-700">Include Non-Core JSON</label>
          </div>
        </div>
        <div>
          <h3 class="text-sm font-semibold mb-2 border-b pb-1">Connector</h3>
          <select id="connectorSelect" disabled class="w-full p-2 border rounded-md text-sm">
            <option value="">(Visualize first)</option>
          </select>
          <div class="mt-2">
            <input id="searchNode" type="text" placeholder="Search node..." class="w-full text-sm p-2 border rounded-md" />
          </div>
        </div>
        <div>
          <h3 class="text-sm font-semibold mb-2 border-b pb-1 flex items-center justify-between">
            <span>Node Filters & Layout</span>
            <button id="resetFilters" class="text-xs text-blue-600 hover:underline">Reset</button>
          </h3>
          <div id="filterContainer" class="grid grid-cols-2 gap-x-3 gap-y-1 filter-group text-xs mb-3"></div>
          <div class="flex flex-wrap gap-2">
            <button id="layoutToggle" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-semibold py-2 rounded-md">Layout: Force</button>
            <button id="exportJson" class="bg-gray-700 hover:bg-gray-800 text-white text-xs font-semibold py-2 px-2 rounded-md">Export JSON</button>
            <button id="exportPng" class="bg-gray-700 hover:bg-gray-800 text-white text-xs font-semibold py-2 px-2 rounded-md">PNG</button>
          </div>
        </div>
        <div id="connectorDetails" class="p-3 bg-gray-50 rounded-lg text-xs text-gray-700">
          <p>Select a connector to view details.</p>
        </div>
        <div id="solutionMeta" class="p-3 bg-gray-50 rounded-lg text-xs text-gray-700">
          <p>Solution metadata will appear here.</p>
        </div>
        <div class="p-3 bg-white border border-gray-200 rounded-lg space-y-2">
          <h4 class="text-xs font-semibold tracking-wide text-gray-600 uppercase">Legend</h4>
          <div id="legendItems" class="space-y-1"></div>
          <p class="mt-2 text-[10px] text-gray-500">
            Solution node shows artifact counts (connectors, DCRs, workbooks, analytics, playbooks, hunting queries).
          </p>
        </div>
        <div class="p-3 bg-white border border-gray-200 rounded-lg">
          <h4 class="text-xs font-semibold mb-1 tracking-wide text-gray-600 uppercase">Diagnostics</h4>
          <p id="rateLimit" class="text-[10px] text-gray-500 mb-2">Rate Limit: (pending)</p>
          <div id="statusLog" class="status-log space-y-0.5 text-[10px] font-mono"></div>
        </div>
      </div>
    </aside>

    <section id="visualization-container" class="xl:col-span-4 h-[900px] relative">
      <div id="tooltip" class="absolute p-2 bg-gray-900 text-white rounded-md shadow-xl text-xs opacity-0 transition"></div>
      <div class="zoom-controls">
        <button id="zoomInBtn" title="Zoom In">+</button>
        <button id="zoomOutBtn" title="Zoom Out">−</button>
        <button id="zoomResetBtn" title="Reset Zoom">⤾</button>
      </div>
      <div class="floating-controls">
        <span class="badge">Graph</span>
        <button id="recenter">Recenter</button>
        <button id="fitView">Fit</button>
        <button id="clearHighlight">Clear Highlight</button>
      </div>
      <svg id="viz" class="w-full h-full">
        <g id="zoomLayer"></g>
      </svg>
      <div id="loadingOverlay" class="hidden absolute inset-0 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center gap-4">
        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="text-sm text-gray-700" id="loadingText">Loading...</p>
      </div>
    </section>
  </div>
</div>

<!-- ===================== SECTION 3: CORE STATE + UTILS ===================== -->
<script>
'use strict';
const qs  = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));

const STATE = {
  connectors: [],
  meta: {},
  graph: { nodes:[], links:[] },
  fullGraph: null,
  layoutMode: 'force',
  cache: new Map(),
  artifacts: null,
  simulation: null,
  zoom: null,
  transform: d3.zoomIdentity,
  lastIncludeNonCore: true      
};

const TYPE_ORDER = [
  'solution','connector','dependency','table','stream',
  'workbook','analyticrule','playbook','huntingquery','functioninfra','deployment','json'
];
const TYPE_LABEL = {
  solution:'Solution',
  connector:'Connector',
  dependency:'DCR',
  table:'Table',
  stream:'Stream',
  workbook:'Workbook',
  analyticrule:'Analytic Rule',
  playbook:'Playbook',
  huntingquery:'Hunting Query',
  functioninfra:'Function Infra',
  deployment:'Deployment',
  json:'JSON'
};
const TYPE_COLOR = {
  solution:'#4f46e5', connector:'#26a69a', dependency:'#81c784', table:'#ff8a65',
  stream:'#9575cd', workbook:'#ffb74d', analyticrule:'#e57373', playbook:'#ec4899',
  huntingquery:'#6366f1', functioninfra:'#4b5563', deployment:'#64748b', json:'#bdbdbd'
};

function logStatus(msg, err=false){
  const log=qs('#statusLog'); if(!log) return;
  const div=document.createElement('div');
  const ts=new Date().toISOString().split('T')[1].replace('Z','');
  div.textContent=`[${ts}] ${msg}`;
  div.className = err?'text-red-600':'text-gray-600';
  log.appendChild(div);
  while (log.children.length>300) log.removeChild(log.firstChild);
  log.scrollTop=log.scrollHeight;
}
function setStatus(msg, err=false){
  const el=qs('#status'); if(el){ el.textContent=msg; el.style.color=err?'#b91c1c':'#4b5563'; }
  logStatus(msg,err);
}
function showLoader(text='Loading...'){ qs('#loadingText').textContent=text; qs('#loadingOverlay')?.classList.remove('hidden'); }
function hideLoader(){ qs('#loadingOverlay')?.classList.add('hidden'); }
function ghHeaders(){
  const t=(qs('#tokenInput')?.value||'').trim();
  return t?{Authorization:`token ${t}`}:{};
}
function updateRateLimit(res){
  if(!res?.headers) return;
  const rem=res.headers.get('x-ratelimit-remaining');
  const lim=res.headers.get('x-ratelimit-limit');
  const reset=res.headers.get('x-ratelimit-reset');
  if(rem&&lim){
    const el=qs('#rateLimit');
    const rs=reset?new Date(parseInt(reset,10)*1000).toLocaleTimeString():'';
    el.textContent=`Rate Limit: ${rem}/${lim}${rs?` (resets ${rs})`:''}`;
  }
}
</script>

<!-- ===================== SECTION 4: DATA FETCH + CLASSIFICATION ===================== -->
<script>
async function fetchJson(url,purpose=''){
  if(STATE.cache.has(url)) return STATE.cache.get(url);
  for(let a=1;a<=3;a++){
    try{
      const res=await fetch(url,{headers:ghHeaders()});
      updateRateLimit(res);
      if(res.status===403 && res.headers.get('x-ratelimit-remaining')==='0'){
        const reset=res.headers.get('x-ratelimit-reset');
        const wait=reset?(parseInt(reset,10)*1000 - Date.now()):60000;
        setStatus(`Rate limited. Waiting ${(wait/1000|0)}s`,true);
        await new Promise(r=>setTimeout(r,Math.max(wait,4000))); continue;
      }
      if(!res.ok){ logStatus(`Fetch fail ${res.status} (${purpose})`,true); return null; }
      const j=await res.json();
      STATE.cache.set(url,j);
      return j;
    }catch(e){
      logStatus(`Fetch error ${a} (${purpose}): ${e.message}`,true);
      await new Promise(r=>setTimeout(r,300*a));
    }
  }
  return null;
}

async function listSolutions(owner,repo,branch){
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/Solutions?ref=${encodeURIComponent(branch)}`;
  const res=await fetch(url,{headers:ghHeaders()}); updateRateLimit(res);
  if(!res.ok) throw new Error(`GitHub API error ${res.status}`);
  const list=await res.json();
  return (list||[]).filter(x=>x.type==='dir').map(x=>x.name).sort();
}

async function listJsonPaths(owner,repo,branch,solution){
  setStatus('Resolving repository tree...');
  const bres=await fetch(`https://api.github.com/repos/${owner}/${repo}/branches/${encodeURIComponent(branch)}`,{headers:ghHeaders()});
  updateRateLimit(bres);
  if(!bres.ok) throw new Error(`Branch lookup failed ${bres.status}`);
  const b=await bres.json();
  const treeSha=b?.commit?.commit?.tree?.sha;
  if(!treeSha) throw new Error('Cannot resolve tree sha');
  const tres=await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/${treeSha}?recursive=1`,{headers:ghHeaders()});
  updateRateLimit(tres);
  if(!tres.ok) throw new Error(`Tree listing failed ${tres.status}`);
  const t=await tres.json();
  const prefix=`Solutions/${solution}/`;
  return (t.tree||[]).filter(n=>n.type==='blob' && n.path.startsWith(prefix) && n.path.toLowerCase().endsWith('.json')).map(n=>n.path);
}

async function fetchAll(owner,repo,branch,paths,includeNonCore){
  const base=`https://raw.githubusercontent.com/${owner}/${repo}/${encodeURIComponent(branch)}/`;
  const coreNames=new Set([
    'maintemplate.json','solutionmetadata.json','connectordefinition.json','pollerconfig.json',
    'dcr.json','tableschema.json','host.json','functionapp.json','azuredeploy.json',
    'createuidefinition.json'
  ]);
  const skipNames = new Set(['testparameters.json']);
  let skippedTestParams=0;
  const out=[];
  for(const p of paths){
    const name=p.split('/').pop().toLowerCase();
    if(skipNames.has(name)){ skippedTestParams++; continue; }
    const isCore=coreNames.has(name);
    if(!includeNonCore && !isCore) continue;
    const js=await fetchJson(base+p,'artifact');
    if(js) out.push({path:p,json:js,core:isCore});
  }
  if(skippedTestParams) logStatus(`Skipped ${skippedTestParams} TestParameters file(s).`);
  logStatus(`Fetched ${out.length} JSON files (${includeNonCore?'core+non-core':'core only'})`);
  return out;
}

function extractTablesFromQuery(q){
  if(!q) return [];
  const r=/\b([A-Za-z0-9_]+_CL)\b|\b([A-Za-z]+Events?)\b|\b(CommonSecurityLog|Syslog|SecurityAlert|SecurityIncident)\b/g;
  const t=[]; for(const m of q.matchAll(r)){ const v=m[1]||m[2]||m[3]; if(v) t.push(v); }
  return [...new Set(t)];
}

function detectConnectorKindCategory(j,lower){
  const k=(j?.kind||j?.properties?.kind||'').toLowerCase();
  const hasDcr=!!j?.properties?.dcrConfig;
  const hasUi=!!(j?.properties?.connectorUiConfig||j?.properties?.connectorUIConfig);
  if(k.includes('restapipoller')||k.includes('apipolling')) return 'CCF – API Poller';
  if(k.includes('codeless')||hasUi) return 'CCF – UI';
  if(hasDcr) return 'Logs Ingestion API';
  const hasDataTypes=Array.isArray(j?.properties?.dataTypes);
  if(hasDataTypes && !hasDcr && /data collector api|http data collector|custom log/i.test(lower)) return 'Legacy – HTTP Data Collector API';
  if(k.includes('azurefunction')||k.includes('datacollector')) return 'Legacy – Function';
  return 'Native/Other';
}

function classify(json,path){
  if(!json || typeof json!=='object') return { type:'json', id:path.split('/').pop(), path, raw:json };
  const lower=JSON.stringify(json).toLowerCase();
  const base=path.split('/').pop().replace(/\.json$/i,'');
  const display=json?.name || json?.properties?.displayName || base;
  const fileLower=path.split('/').pop().toLowerCase();

  if(fileLower==='azuredeploy.json') return { type:'deployment', id:'Azure Deploy', path, raw:json };
  if(fileLower==='host.json' || fileLower==='functionapp.json') return { type:'functioninfra', id:base, path, raw:json };

  if(lower.includes('microsoft.insights/datacollectionrules') || json?.properties?.dataFlows || json?.dataFlows){
    const flows=json?.properties?.dataFlows || json?.dataFlows || [];
    const tables=new Set(), streams=new Set();
    flows.forEach(f=>{
      (f.streams||[]).forEach(s=>streams.add(s));
      const tf=f.transformKql?String(f.transformKql):'';
      const m=tf.match(/into\s+table\s+([a-z0-9_]+)/i);
      if(m && m[1]) tables.add(m[1]);
      (f.streams||[]).forEach(s=>tables.add(s));
    });
    return { type:'dependency', id:display, path, raw:json, tables:[...tables], streams:[...streams] };
  }

  const ui=json?.properties?.connectorUiConfig || json?.properties?.connectorUIConfig;
  const kind=(json?.kind||json?.properties?.kind||'').toLowerCase();
  if(ui || lower.includes('dataconnector') ||
     kind.includes('restapipoller') || kind.includes('apipolling') ||
     kind.includes('codeless') || json?.properties?.dcrConfig ||
     kind.includes('azurefunction') || kind.includes('datacollector')){
    let mechanism='Service';
    if(kind.includes('restapipoller')||kind.includes('apipolling')) mechanism='CCF - API Polling';
    else if(kind.includes('codeless')) mechanism='CCF - UI';
    else if(json?.properties?.dcrConfig) mechanism='Logs Ingestion API';
    else if(kind.includes('azurefunction')||kind.includes('datacollector')) mechanism='Legacy - Function/DataCollector';
    const kindCategory=detectConnectorKindCategory(json,lower);
    const tables = Array.isArray(json?.properties?.dataTypes)
      ? json.properties.dataTypes.map(dt=>dt.name||dt).filter(Boolean) : [];
    const streams=[];
    const dcrCfg=json?.properties?.dcrConfig;
    if(dcrCfg?.streamDeclarations){
      dcrCfg.streamDeclarations.forEach(s=>s?.streamName && streams.push(s.streamName));
    }
    return {
      type:'connector', id: ui?.title || ui?.displayName || display, path, raw:json,
      mechanism, kindCategory,
      tables:[...new Set(tables)],
      streams:[...new Set(streams)],
      description: ui?.description || json?.properties?.description || ''
    };
  }

  if(path.toLowerCase().includes('/workbooks/') || lower.includes('"workbook"')){
    const query=json?.properties?.query || json?.query || '';
    return { type:'workbook', id:display, path, raw:json, tables:extractTablesFromQuery(query), description: json?.properties?.description||'' };
  }

  if(path.toLowerCase().includes('/analytics/') || lower.includes('alertrule') || json?.properties?.query){
    const query=json?.properties?.query || json?.query || '';
    return { type:'analyticrule', id:display, path, raw:json, tables:extractTablesFromQuery(query) };
  }

  if(path.toLowerCase().includes('/hunting queries/') || path.toLowerCase().includes('/huntingqueries/')){
    const query=json?.properties?.query || json?.query || '';
    return { type:'huntingquery', id:display, path, raw:json, tables:extractTablesFromQuery(query) };
  }

  if(path.toLowerCase().includes('/playbooks/') || lower.includes('"logicapp"')){
    return { type:'playbook', id:display, path, raw:json };
  }

  if(json?.metadata?.dependencies || json?.templateSpecs?.dependencies){
    return { type:'dependency', id:display, path, raw:json,
             dependencies:(json.metadata?.dependencies || json.templateSpecs?.dependencies || []) };
  }

  return { type:'json', id:display, path, raw:json };
}

function buildArtifacts(files){
  const acc={connectors:[],dcrs:[],workbooks:[],analytics:[],playbooks:[],hunting:[],infra:[],deploy:[],others:[]};
  files.forEach(f=>{
    const c=classify(f.json,f.path);
    switch(c.type){
      case 'connector': acc.connectors.push(c); break;
      case 'dependency': acc.dcrs.push(c); break;
      case 'workbook': acc.workbooks.push(c); break;
      case 'analyticrule': acc.analytics.push(c); break;
      case 'playbook': acc.playbooks.push(c); break;
      case 'huntingquery': acc.hunting.push(c); break;
      case 'functioninfra': acc.infra.push(c); break;
      case 'deployment': acc.deploy.push(c); break;
      default: acc.others.push(c); break;
    }
  });

  // Heuristic connector->DCR link
  const dcrIdsLower=new Map(acc.dcrs.map(d=>[d.id.toLowerCase(),d.id]));
  acc.connectors.forEach(c=>{
    const text=JSON.stringify(c.raw||{}).toLowerCase();
    c.linkedDcrIds=[];
    dcrIdsLower.forEach((orig,low)=>{ if(text.includes(low)) c.linkedDcrIds.push(orig); });
  });

  // Presence flags (add solutionmetadata)
  const nameSet=new Set(files.map(f=>f.path.split('/').pop().toLowerCase()));
  acc.filePresence={
    hasPollerConfig:nameSet.has('pollerconfig.json'),
    hasDcr:nameSet.has('dcr.json'),
    hasHost:nameSet.has('host.json'),
    hasFunctionApp:nameSet.has('functionapp.json'),
    hasCreateUiDefinition:nameSet.has('createuidefinition.json'),
    hasSolutionMetadata:nameSet.has('solutionmetadata.json')
  };

  return acc;
}
async function extractMaintemplate(owner,repo,branch,solution,paths){
  const mt=paths.find(p=>/main(template)?\.json$/i.test(p));
  if(!mt) return { solutionName:solution, publisher:'Unknown', contactEmail:'Unknown' };
  const base=`https://raw.githubusercontent.com/${owner}/${repo}/${encodeURIComponent(branch)}/`;
  const js=await fetchJson(base+mt,'maintemplate');
  if(!js) return { solutionName:solution, publisher:'Unknown', contactEmail:'Unknown' };
  const params=js.parameters||{};
  function pick(...keys){
    for(const k of keys){
      const v=k.split('.').reduce((o,part)=>o?o[part]:undefined, js) ??
              k.split('.').reduce((o,part)=>o?o[part]:undefined, params);
      if(typeof v==='string') return v;
      if(v && typeof v==='object' && 'defaultValue' in v) return v.defaultValue;
    }
    return '';
  }
  return {
    solutionName: pick('SolutionName','solutionName','SolutionName.defaultValue','solutionName.defaultValue') || solution,
    publisher: pick('Publisher','publisher','Publisher.defaultValue','publisher.defaultValue','metadata.publisherId') || 'Unknown',
    contactEmail: pick('ContactEmail','contactEmail','ContactEmail.defaultValue','contactEmail.defaultValue','metadata.contactEmail') || 'Unknown'
  };
}
</script>

<!-- ===================== SECTION 5: GRAPH + APP ===================== -->
<script>
function buildGraph(art, solutionName){
  const nodes=[], links=[], nodeMap=new Map();
  const addNode=(id,type,meta={})=>{
    if(!id) return;
    const key=type+'::'+id;
    if(!nodeMap.has(key)){ nodeMap.set(key,{id,type,meta}); nodes.push(nodeMap.get(key)); }
    else Object.assign(nodeMap.get(key).meta, meta);
  };
  const addLink=(s,t,type)=>{
    if(!s||!t) return;
    if(links.some(l=>l.source===s&&l.target===t&&l.edgeType===type)) return;
    links.push({source:s,target:t,edgeType:type});
  };
  const root=solutionName || 'Solution';
  addNode(root,'solution',{});
  art.connectors.forEach(c=>{
    addNode(c.id,'connector',c);
    addLink(root,c.id,'solution-connector');
  });
  art.dcrs.forEach(d=>{
    addNode(d.id,'dependency',{tables:d.tables,streams:d.streams});
    addLink(root,d.id,'solution-dcr');
    (d.tables||[]).forEach(tb=>{ addNode(tb,'table',{}); addLink(d.id,tb,'dcr-table'); });
  });
  art.connectors.forEach(c=>{
    (c.linkedDcrIds||[]).forEach(did=>addLink(c.id,did,'connector-dcr'));
    (c.tables||[]).forEach(tb=>{ addNode(tb,'table',{}); addLink(c.id,tb,'connector-table'); });
    (c.streams||[]).forEach(st=>{ addNode(st,'stream',{}); addLink(c.id,st,'connector-stream'); });
  });
  art.workbooks.forEach(w=>{
    addNode(w.id,'workbook',{tables:w.tables,description:w.description});
    addLink(root,w.id,'solution-workbook');
    w.tables.forEach(tb=>{ if(nodes.find(n=>n.id===tb)) addLink(tb,w.id,'table-workbook'); });
  });
  art.analytics.forEach(a=>{
    addNode(a.id,'analyticrule',{tables:a.tables});
    addLink(root,a.id,'solution-analytic');
    a.tables.forEach(tb=>{ if(nodes.find(n=>n.id===tb)) addLink(tb,a.id,'table-analytic'); });
  });
  art.playbooks.forEach(p=>{
    addNode(p.id,'playbook',{path:p.path}); addLink(root,p.id,'solution-playbook');
  });
  art.hunting.forEach(h=>{
    addNode(h.id,'huntingquery',{tables:h.tables}); addLink(root,h.id,'solution-hunting');
    h.tables.forEach(tb=>{ if(nodes.find(n=>n.id===tb)) addLink(tb,h.id,'table-hunting'); });
  });
  art.infra.forEach(f=>{
    addNode(f.id,'functioninfra',{path:f.path}); addLink(root,f.id,'solution-infra');
  });
  art.deploy.forEach(d=>{
    addNode(d.id,'deployment',{path:d.path}); addLink(root,d.id,'solution-deployment');
  });
  art.others.slice(0,50).forEach(o=>{
    addNode(o.id,'json',{path:o.path}); addLink(root,o.id,'solution-json');
  });
  const solNode=nodes.find(n=>n.type==='solution' && n.id===root);
  if(solNode){
    solNode.meta.counts={
      connectors:art.connectors.length,
      dcrs:art.dcrs.length,
      workbooks:art.workbooks.length,
      analytics:art.analytics.length,
      playbooks:art.playbooks.length,
      hunting:art.hunting.length
    };
  }
  return {nodes,links};
}

function setupTooltip(){
  const tip=d3.select('#tooltip');
  return {
    show(evt,d){
      let h=`<b>${(TYPE_LABEL[d.type]||d.type).toUpperCase()}</b><hr class="my-1"/>`;
      if(d.type==='solution'){
        h+=`<b>Name:</b> ${d.id}<br>`;
        if(d.meta?.counts){
          const c=d.meta.counts;
          h+=`<b>Artifacts:</b> ${c.connectors} connectors, ${c.dcrs} DCR, ${c.workbooks} workbooks, ${c.analytics} analytics<br>`;
        }
      } else if(d.type==='connector'){
        h+=`<b>Name:</b> ${d.id}<br>`;
        if(d.meta.kindCategory) h+=`<b>Kind:</b> ${d.meta.kindCategory}<br>`;
        h+=`<b>Mechanism:</b> ${d.meta.mechanism||''}<br>`;
        h+=`<b>Tables:</b> ${(d.meta.tables||[]).length?(d.meta.tables.slice(0,10).join(', ')):'—'}<br>`;
        if((d.meta.streams||[]).length) h+=`<b>Streams:</b> ${d.meta.streams.join(', ')}<br>`;
        if(d.meta.description) h+=`<b>Description:</b> ${d.meta.description.slice(0,160)}<br>`;
      } else if(d.type==='dependency'){
        h+=`<b>DCR:</b> ${d.id}<br><b>Tables:</b> ${(d.meta.tables||[]).join(', ')||'—'}`;
      } else if(d.type==='workbook'){
        h+=`<b>Workbook:</b> ${d.id}<br>`;
        if(d.meta.description) h+=`<b>Description:</b> ${d.meta.description.slice(0,140)}<br>`;
        if((d.meta.tables||[]).length) h+=`<b>Tables:</b> ${d.meta.tables.join(', ')}<br>`;
      } else if(d.type==='analyticrule'){
        h+=`<b>Analytic Rule:</b> ${d.id}<br>`;
        if((d.meta.tables||[]).length) h+=`<b>Tables:</b> ${d.meta.tables.join(', ')}`;
      } else {
        h+=`<b>ID:</b> ${d.id}`;
        if(d.meta?.path) h+=`<br><b>Path:</b> ${d.meta.path}`;
      }
      tip.html(h)
        .style('left',(evt.clientX+14)+'px')
        .style('top',(evt.clientY+10)+'px')
        .style('opacity',1);
    },
    hide(){ tip.style('opacity',0); }
  };
}

function renderGraph({preserveTransform=false}={}){
  const nodes=STATE.graph.nodes, links=STATE.graph.links;
  const svg=d3.select('#viz'), layer=d3.select('#zoomLayer');
  layer.selectAll('*').remove();
  const w=svg.node().clientWidth||1400, h=svg.node().clientHeight||900;
  const tip=setupTooltip();

  // marker (unchanged)
  layer.append('defs').append('marker')
    .attr('id','arrow').attr('viewBox','0 -5 10 10').attr('refX',18).attr('refY',0)
    .attr('markerWidth',7).attr('markerHeight',7).attr('orient','auto')
    .append('path').attr('d','M0,-5L10,0L0,5').attr('fill','#555');

  const link=layer.append('g').attr('class','links')
    .attr('stroke','#555').attr('stroke-opacity',0.45)
    .selectAll('path').data(links).enter().append('path')
    .attr('class','graph-link')
    .attr('fill','none')
    .attr('stroke-width',1.3)
    .attr('marker-end','url(#arrow)');

  const group=layer.append('g').attr('class','nodes')
    .selectAll('g').data(nodes,d=>d.id).enter().append('g')
    .attr('class','node-group fade-enter')
    .on('mouseover',tip.show)
    .on('mouseout',tip.hide)
    .on('click',(e,d)=>{
      if(d.type==='connector'){
        qs('#connectorSelect').value=d.id;
        displayConnectorInfo(d.id);
      }
      highlightNode(d.id);
      tip.show(e,d);
    })
    .call(d3.drag()
      .on('start',(e,d)=>{ d.fx=d.x; d.fy=d.y; })
      .on('drag',(e,d)=>{ d.fx=e.x; d.fy=e.y; STATE.simulation && STATE.simulation.alpha(0.1).restart(); })
      .on('end',(e,d)=>{ if(STATE.simulation && STATE.layoutMode==='force'){ d.fx=null; d.fy=null; } })
    );

  // UPDATED sizing constants
  const NODE_WIDTH = 160;
  const FONT_SIZE  = 11;
  const MAX_DCR_INLINE = 4;
  const MAX_CONN_INLINE = 3;
  const MAX_LINES = 9;          // Cap, with ellipsis
  const CHAR_PER_LINE = 22;     // Wrap width tuned for 160px

  const wrap=(text,maxChars=CHAR_PER_LINE)=>{
    const out=[];
    text.split('\n').forEach(line=>{
      let cur='';
      line.split(' ').forEach(w=>{
        if((cur+w).length>maxChars){
          if(cur) out.push(cur.trim());
          cur=w+' ';
        } else {
          cur+=w+' ';
        }
      });
      if(cur) out.push(cur.trim());
    });
    return out;
  };

  group.each(function(d){
    const g=d3.select(this); const lines=[];

    if(d.type==='solution'){
      lines.push(d.id);
      if(d.meta?.counts){
        const c=d.meta.counts;
        lines.push(`Conn:${c.connectors} DCR:${c.dcrs}`);
        lines.push(`Wk:${c.workbooks} Ar:${c.analytics}`);
      }
    } else if(d.type==='connector'){
      lines.push(d.id);
      if(d.meta.kindCategory) lines.push(d.meta.kindCategory);
      if(d.meta.mechanism) lines.push(`[${d.meta.mechanism}]`);
      const t=d.meta.tables||[];
      if(t.length){
        const shown=t.slice(0,MAX_CONN_INLINE).join(',');
        lines.push(`Tbl:${shown}${t.length>MAX_CONN_INLINE?`+${t.length-MAX_CONN_INLINE}`:''}`);
      }
    } else if(d.type==='dependency'){
      lines.push('DCR');
      lines.push(d.id);
      const t=d.meta.tables||[];
      if(t.length){
        t.slice(0,MAX_DCR_INLINE).forEach(tb=>lines.push(tb));
        if(t.length>MAX_DCR_INLINE) lines.push(`+${t.length-MAX_DCR_INLINE} more`);
      } else lines.push('(no tables)');
    } else if(d.type==='workbook'){ lines.push('Workbook', d.id);
    } else if(d.type==='analyticrule'){ lines.push('Analytic', d.id);
    } else if(d.type==='playbook'){ lines.push('Playbook', d.id);
    } else if(d.type==='huntingquery'){ lines.push('Hunting', d.id);
    } else if(d.type==='functioninfra'){ lines.push('FunctionInfra', d.id);
    } else if(d.type==='deployment'){ lines.push('Deployment', d.id);
    } else if(d.type==='stream'){ lines.push('Stream', d.id);
    } else { lines.push(d.id); }

    // Wrap and clamp
    let wrapped = lines.flatMap(l=>wrap(l));
    if (wrapped.length > MAX_LINES){
      wrapped = wrapped.slice(0, MAX_LINES-1);
      wrapped.push('…');
    }

    const height = Math.max(46, wrapped.length*(FONT_SIZE+2)+14);

    g.append('rect')
     .attr('width',NODE_WIDTH).attr('height',height)
     .attr('x',-NODE_WIDTH/2).attr('y',-height/2)
     .attr('rx',9)
     .attr('fill', TYPE_COLOR[d.type]||'#ddd')
     .attr('stroke','#1e293b')
     .attr('stroke-width',1.2);

    wrapped.forEach((ln,i)=>{
      g.append('text')
       .attr('text-anchor','middle')
       .attr('font-size',FONT_SIZE)
       .attr('font-weight', i===0?600:400)
       .attr('y',(-height/2+16)+i*(FONT_SIZE+2))
       .attr('fill','#1f2937')
       .text(ln);
    });
  });

  function positionLinks(){
    link.attr('d',l=>{
      const s=nodes.find(n=>n.id===l.source)||l.source;
      const t=nodes.find(n=>n.id===l.target)||l.target;
      if(!s||!t) return '';
      const dx=t.x-s.x, dy=t.y-s.y, dr=Math.sqrt(dx*dx+dy*dy)*1.15;
      return `M${s.x},${s.y}A${dr},${dr} 0 0,1 ${t.x},${t.y}`;
    });
  }

  if(STATE.layoutMode==='layered'){
    const grouped=TYPE_ORDER.map(t=>nodes.filter(n=>n.type===t));
    const vis=grouped.filter(g=>g.length);
    const cx=w/2, cy=h/2;
    const gap=Math.min(w,h)/(2*(vis.length+1));
    vis.forEach((arr,i)=>{
      const r=gap*(i+1);
      arr.forEach((n,idx)=>{
        const angle=(idx/arr.length)*2*Math.PI;
        n.x=cx + r*Math.cos(angle);
        n.y=cy + r*Math.sin(angle);
      });
    });
    group.attr('transform',d=>`translate(${d.x},${d.y})`);
    positionLinks();
    STATE.simulation=null;
  } else {
    const sim=d3.forceSimulation(nodes)
      .force('link', d3.forceLink(links).id(d=>d.id).distance(120).strength(0.9))
      .force('charge', d3.forceManyBody().strength(-300))
      .force('collide', d3.forceCollide(65))   // reduced for smaller nodes
      .force('center', d3.forceCenter(w/2,h/2));
    sim.on('tick',()=>{
      nodes.forEach(n=>{
        n.x=Math.max(40,Math.min(w-40,n.x||w/2));
        n.y=Math.max(40,Math.min(h-40,n.y||h/2));
      });
      group.attr('transform',d=>`translate(${d.x},${d.y})`);
      positionLinks();
    });
    STATE.simulation=sim;
  }

  if(!preserveTransform){
    STATE.transform=d3.zoomIdentity;
    d3.select('#viz').transition().duration(0).call(STATE.zoom.transform, STATE.transform);
    fitToView(0);
  }
}

function highlightNode(id){
  const g=d3.select('#zoomLayer').selectAll('.node-group');
  const links=d3.select('#zoomLayer').selectAll('.graph-link');
  if(!id){
    g.selectAll('rect').attr('opacity',1).attr('stroke-width',1.3);
    links.attr('stroke-opacity',0.45).attr('stroke-width',1.4);
    return;
  }
  const connected=new Set([id]);
  STATE.graph.links.forEach(l=>{
    if(l.source===id) connected.add(l.target);
    if(l.target===id) connected.add(l.source);
  });
  g.selectAll('rect')
    .attr('opacity',d=>connected.has(d.id)?1:0.15)
    .attr('stroke-width',d=>d.id===id?3:1.3);
  links
    .attr('stroke-opacity',l=> (l.source===id||l.target===id)?1:0.06)
    .attr('stroke-width',l=> (l.source===id||l.target===id)?3:1.1);
}

function updateMetadataPanel(meta, art){
  const div=qs('#solutionMeta');
  if(!meta){ div.innerHTML='<p class="text-xs text-gray-500">No metadata.</p>'; return; }
  const uniqueTables=new Set();
  art.connectors.forEach(c=>(c.tables||[]).forEach(t=>uniqueTables.add(t)));
  art.dcrs.forEach(d=>(d.tables||[]).forEach(t=>uniqueTables.add(t)));
  const fp=art.filePresence||{};
  div.innerHTML=`
    <h4 class="text-xs font-semibold tracking-wide uppercase text-gray-600 mb-1">Solution Metadata</h4>
    <ul class="text-[11px] space-y-1">
      <li><b>Name:</b> ${meta.solutionName}</li>
      <li><b>Publisher:</b> ${meta.publisher}</li>
      <li><b>Contact:</b> ${meta.contactEmail}</li>
      <li><b>Published (Content Hub):</b> ${meta.published}</li>
      <li><b>Artifacts:</b>
        Conn ${art.connectors.length} | DCR ${art.dcrs.length} | Wkb ${art.workbooks.length} |
        Analytic ${art.analytics.length} | Playbook ${art.playbooks.length} | Hunting ${art.hunting.length}
      </li>
      <li><b>Unique Tables (Conn + DCR):</b> ${uniqueTables.size}</li>
      <li><b>Non-Core Included:</b> ${STATE.lastIncludeNonCore ? 'Yes' : 'No'}</li>
      <li><b>Core Files:</b>
        <span class="${fp.hasSolutionMetadata?'text-green-600':'text-gray-400'}">solutionMetadata</span>,
        <span class="${fp.hasCreateUiDefinition?'text-green-600':'text-gray-400'}">createUiDef</span>,
        <span class="${fp.hasPollerConfig?'text-green-600':'text-gray-400'}">pollerConfig</span>,
        <span class="${fp.hasDcr?'text-green-600':'text-gray-400'}">dcr</span>,
        <span class="${fp.hasHost?'text-green-600':'text-gray-400'}">host</span>,
        <span class="${fp.hasFunctionApp?'text-green-600':'text-gray-400'}">functionApp</span>
      </li>
      <li class="text-[10px] text-gray-500 italic">TestParameters JSON files are excluded from analysis.</li>
    </ul>`;
}

function populateConnectorSelect(connectors){
  const sel=qs('#connectorSelect');
  sel.innerHTML='<option value="">-- Select Connector --</option>';
  if(!connectors.length){ sel.disabled=true; return; }
  connectors.forEach(c=>{
    const o=document.createElement('option');
    o.value=c.id; o.textContent=c.id; sel.appendChild(o);
  });
  sel.disabled=false;
}

function normalizeMechanism(mech){
  if(!mech) return '';
  if(/CCF.*API Poll/i.test(mech) || /API Polling/i.test(mech))
    return 'CCF (Codeless) - API Poller';
  if(/CCF.*UI/i.test(mech) || /CCF - UI/i.test(mech))
    return 'CCF (Codeless) - UI Driven';
  if(/Logs Ingestion API/i.test(mech))
    return 'Logs Ingestion API';
  if(/Legacy/i.test(mech))
    return 'Legacy - Function';
  return mech;
}
function deriveDataFlow(conn){
  const mech = (conn.mechanism||'').toLowerCase();
  if(mech.includes('poll')) return 'Pull';
  return 'Push';
}
function deriveDataSource(conn){
  // Take id, strip parentheses e.g. "1Password (Serverless)" -> "1Password"
  return (conn.id||'').replace(/\(.*?\)/,'').trim();
}
function displayConnectorInfo(name){
  const c=STATE.connectors.find(x=>x.id===name);
  const div=qs('#connectorDetails');
  if(!c){
    div.innerHTML='<p class="text-xs text-gray-500">Select a connector above to view its technical classification.</p>';
    highlightNode(null);
    return;
  }
  const mechNorm=normalizeMechanism(c.mechanism);
  const isCcf=/CCF \(Codeless\)/i.test(mechNorm);
  const badgeClass=isCcf?'bg-green-100 text-green-800':'bg-orange-100 text-orange-800';
  const dataFlow=deriveDataFlow(c);
  const dataSource=deriveDataSource(c);
  const streams=(c.streams||[]).join(', ') || 'N/A';
  const tables=(c.tables||[]).join(', ') || 'N/A';
  const uiConfig = c.raw?.properties?.connectorUiConfig || c.raw?.properties?.connectorUIConfig ? 'Yes' : 'No';
  const queryArtifactsLinked = (c.analyticCount||0)+(c.huntingCount||0);
  div.innerHTML=`
    <h3 class="text-xs font-semibold border-b pb-1 mb-2 text-blue-600 uppercase">Connector Classification</h3>
    <ul class="text-[11px] space-y-2">
      <li class="p-2 rounded-lg font-bold ${badgeClass}">
        <span class="text-[12px]">${mechNorm||'Unknown Mechanism'}</span>
      </li>
      <li class="p-2 rounded-lg bg-gray-100 text-gray-800"><b>Data Flow:</b> ${dataFlow}</li>
      <li class="p-2 rounded-lg bg-gray-100 text-gray-800"><b>Data Source:</b> ${dataSource||'N/A'}</li>
      <li class="p-2 rounded-lg bg-gray-100 text-gray-800"><b>Streams:</b> ${streams}</li>
      <li class="p-2 rounded-lg bg-gray-100 text-gray-800"><b>Tables:</b> ${tables}</li>
      <li class="p-2 rounded-lg bg-gray-100 text-gray-800"><b>UI Config:</b> ${uiConfig}</li>
      <li class="p-2 rounded-lg bg-gray-100 text-gray-800"><b>Query Artifacts Linked:</b> ${queryArtifactsLinked}</li>
    </ul>
    <div class="mt-2 text-[10px] text-gray-500 break-all"><b>Path:</b> ${c.path||''}</div>
  `;
  highlightNode(name);
}

function displayConnectorInfo(id){
  const c=STATE.connectors.find(x=>x.id===id);
  const div=qs('#connectorDetails');
  if(!c){ div.innerHTML='<p class="text-xs text-gray-500">Select a connector.</p>'; return; }
  div.innerHTML=`
    <h4 class="text-xs font-semibold mb-1 tracking-wide uppercase text-gray-600">Connector</h4>
    <div class="text-[11px] space-y-1">
      <div><b>Name:</b> ${c.id}</div>
      <div><b>Kind Category:</b> ${c.kindCategory||'—'}</div>
      <div><b>Mechanism:</b> <span class="mechanism-badge">${c.mechanism||''}</span></div>
      <div><b>Tables:</b> ${(c.tables||[]).length?c.tables.join(', '):'—'}</div>
      <div><b>Streams:</b> ${(c.streams||[]).length?c.streams.join(', '):'—'}</div>
      <div><b>Description:</b> ${c.description||'—'}</div>
      <div class="text-[10px] text-gray-400 break-all"><b>Path:</b> ${c.path||''}</div>
    </div>`;
  highlightNode(id);
}

function buildFiltersUI(){
  const cont=qs('#filterContainer');
  const types=new Set(STATE.fullGraph?.nodes.map(n=>n.type));
  cont.innerHTML='';
  TYPE_ORDER.forEach(t=>{
    if(!types.has(t)) return;
    const isSolution = t==='solution';
    const lbl=document.createElement('label');
    lbl.className='flex items-center gap-1';
    lbl.innerHTML=`
      <input type="checkbox" data-filter="${t}" ${isSolution?'checked disabled':'checked'}>
      ${TYPE_LABEL[t]||t}`;
    cont.appendChild(lbl);
  });
  qsa('[data-filter]').forEach(cb=>!cb.disabled && cb.addEventListener('change',applyFilters));
}

function applyFilters(){
  if(!STATE.fullGraph) return;
  const active=new Set(
    qsa('[data-filter]').filter(cb=>cb.checked).map(cb=>cb.getAttribute('data-filter'))
  );
  // Always force include solution
  active.add('solution');

  const all=STATE.fullGraph;
  const fnodes=all.nodes.filter(n=>active.has(n.type));
  const ids=new Set(fnodes.map(n=>n.id));

  // Keep links only where both endpoints remain
  const flinks=all.links.filter(l=>ids.has(l.source)&&ids.has(l.target));

  STATE.graph={nodes:fnodes,links:flinks};
  renderGraph({preserveTransform:true});
  buildLegend();
}
function buildLegend(){
  const legend=qs('#legendItems');
  legend.innerHTML='';
  Object.entries(TYPE_COLOR).forEach(([t,color])=>{
    if(!STATE.graph.nodes.some(n=>n.type===t)) return;
    const div=document.createElement('div');
    div.className='legend-item';
    div.innerHTML=`<span class="legend-swatch" style="background:${color}"></span> ${TYPE_LABEL[t]||t}`;
    legend.appendChild(div);
  });
}

function exportGraphJson(){
  const blob=new Blob([JSON.stringify({metadata:STATE.meta,nodes:STATE.graph.nodes,links:STATE.graph.links},null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download='sentinel-graph.json'; a.click();
  URL.revokeObjectURL(a.href);
}
function exportPng(){
  const svgEl=qs('#viz'); if(!svgEl) return;
  const xml=new XMLSerializer().serializeToString(svgEl);
  const canvas=document.createElement('canvas');
  canvas.width=svgEl.clientWidth||1400; canvas.height=svgEl.clientHeight||900;
  const ctx=canvas.getContext('2d');
  const img=new Image();
  img.onload=()=>{
    ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img,0,0);
    const link=document.createElement('a');
    link.download='sentinel-graph.png';
    link.href=canvas.toDataURL('image/png');
    link.click();
  };
  img.src='data:image/svg+xml;base64,'+btoa(unescape(encodeURIComponent(xml)));
}

function resetAll(){
  STATE.graph={nodes:[],links:[]};
  STATE.connectors=[];
  STATE.artifacts=null;
  qs('#zoomLayer').innerHTML='';
  qs('#connectorSelect').innerHTML='<option value="">(Visualize first)</option>';
  qs('#connectorSelect').disabled=true;
  qs('#connectorDetails').innerHTML='<p>Select a connector to view details.</p>';
  qs('#solutionMeta').innerHTML='<p>Solution metadata will appear here.</p>';
  setStatus('Visualization reset. Load & visualize a solution.');
}

function fitToView(duration=600){
  const nodes=STATE.graph.nodes; if(!nodes.length) return;
  const svg=d3.select('#viz');
  const w=svg.node().clientWidth, h=svg.node().clientHeight;
  const minX=Math.min(...nodes.map(n=>n.x||0)), maxX=Math.max(...nodes.map(n=>n.x||0));
  const minY=Math.min(...nodes.map(n=>n.y||0)), maxY=Math.max(...nodes.map(n=>n.y||0));
  const dx=maxX-minX, dy=maxY-minY;
  const scale=Math.min(3,0.9/Math.max(dx/w,dy/h));
  const cx=(minX+maxX)/2, cy=(minY+maxY)/2;
  const t=d3.zoomIdentity.translate(w/2,h/2).scale(scale).translate(-cx,-cy);
  d3.select('#viz').transition().duration(duration).call(STATE.zoom.transform,t);
  STATE.transform=t;
}

function zoomBy(f){
  const svg=d3.select('#viz'); const w=svg.node().clientWidth; const h=svg.node().clientHeight;
  const t=STATE.transform.translate(w/2,h/2).scale(f).translate(-w/2,-h/2);
  const k=Math.min(4,Math.max(0.2,t.k));
  const final=d3.zoomIdentity.translate(t.x,t.y).scale(k);
  svg.transition().duration(250).call(STATE.zoom.transform,final);
  STATE.transform=final;
}

async function loadSolutionsHandler(){
  try{
    const repoStr=qs('#repoInput').value.trim();
    if(!repoStr.includes('/')) return setStatus('Repo must be owner/repo',true);
    const [owner,repo]=repoStr.split('/');
    const branch=qs('#branchInput').value.trim();
    setStatus('Loading solutions list...');
    showLoader('Listing solutions...');
    const sols=await listSolutions(owner,repo,branch);
    const sel=qs('#solutionSelect');
    sel.innerHTML='';
    if(!sols.length){
      sel.innerHTML='<option value="">(No solutions found)</option>';
      setStatus('No solutions found',true);
      return;
    }
    sols.forEach(s=>{
      const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o);
    });
    setStatus(`Loaded ${sols.length} solutions. Choose one, then Visualize.`);
  }catch(e){
    setStatus(e.message||'Error loading solutions',true);
  } finally { hideLoader(); }
}

async function visualizeHandler(){
  try{
    showLoader('Building visualization...');
    STATE.cache.clear();
    const repoStr=qs('#repoInput').value.trim();
    const sol=qs('#solutionSelect').value.trim();
    const branch=qs('#branchInput').value.trim();
    const includeNonCore=qs('#includeNonCore').checked;
    STATE.lastIncludeNonCore = includeNonCore;
    if(!repoStr.includes('/')||!sol) return setStatus('Select repo & solution first',true);
    const [owner,repo]=repoStr.split('/');
    setStatus(`Gathering JSON file paths for ${sol}...`);
    const paths=await listJsonPaths(owner,repo,branch,sol);
    if(!paths.length) return setStatus('No JSON for solution',true);
    setStatus(`Downloading JSON (${includeNonCore?'core + non-core':'core only'})...`);
    const files=await fetchAll(owner,repo,branch,paths,includeNonCore);

    setStatus('Classifying artifacts...');
    const art=buildArtifacts(files);

    // Compute query artifact linkage counts per connector (analytics + hunting)
    const analyticsByTable=new Map();
    art.analytics.forEach(a=>{
      (a.tables||[]).forEach(t=>{
        if(!analyticsByTable.has(t)) analyticsByTable.set(t,[]);
        analyticsByTable.get(t).push(a);
      });
    });
    const huntingByTable=new Map();
    art.hunting.forEach(h=>{
      (h.tables||[]).forEach(t=>{
        if(!huntingByTable.has(t)) huntingByTable.set(t,[]);
        huntingByTable.get(t).push(h);
      });
    });
    art.connectors.forEach(c=>{
      const tables=c.tables||[];
      let analyticCount=0, huntingCount=0;
      tables.forEach(t=>{
        analyticCount += (analyticsByTable.get(t)||[]).length;
        huntingCount  += (huntingByTable.get(t)||[]).length;
      });
      c.analyticCount=analyticCount;
      c.huntingCount=huntingCount;
    });

    STATE.artifacts=art;
    STATE.connectors=art.connectors;
    populateConnectorSelect(STATE.connectors);

    const meta=await extractMaintemplate(owner,repo,branch,sol,paths);
    // Heuristic published flag
    meta.published = art.filePresence.hasSolutionMetadata ? 'Yes' : 'Unknown / No metadata';
    STATE.meta=meta;
    updateMetadataPanel(meta, art);

    const graph=buildGraph(art, meta.solutionName||sol);
    STATE.fullGraph=graph;          // snapshot full graph
    STATE.graph=graph;
    buildFiltersUI();
    buildLegend();
    setStatus('Rendering graph...');
    renderGraph();
    setStatus(`Done. Nodes: ${graph.nodes.length} Links: ${graph.links.length}`);
  }catch(e){
    setStatus(e.message||'Error',true);
  } finally { hideLoader(); }
}

function resetFilters(){
  qsa('[data-filter]').forEach(cb=>cb.checked=true);
  if(STATE.artifacts){
    STATE.graph=buildGraph(STATE.artifacts, STATE.meta.solutionName);
    renderGraph();
  }
}

document.addEventListener('DOMContentLoaded',()=>{
  STATE.zoom = d3.zoom().scaleExtent([0.2,4]).on('zoom',ev=>{
    STATE.transform=ev.transform;
    d3.select('#zoomLayer').attr('transform',ev.transform);
  });
  d3.select('#viz').call(STATE.zoom);

  qs('#btnLoad').addEventListener('click', loadSolutionsHandler);
  qs('#btnViz').addEventListener('click', visualizeHandler);
  qs('#btnReset').addEventListener('click', resetAll);
  qs('#connectorSelect').addEventListener('change',e=>displayConnectorInfo(e.target.value));
  qs('#resetFilters').addEventListener('click', resetFilters);
  qs('#layoutToggle').addEventListener('click',()=>{
    STATE.layoutMode = STATE.layoutMode==='force' ? 'layered':'force';
    qs('#layoutToggle').textContent=`Layout: ${STATE.layoutMode.charAt(0).toUpperCase()+STATE.layoutMode.slice(1)}`;
    renderGraph({preserveTransform:false});
  });
  qs('#exportJson').addEventListener('click', exportGraphJson);
  qs('#exportPng').addEventListener('click', exportPng);
  qs('#clearHighlight').addEventListener('click', ()=>highlightNode(null));
  qs('#recenter').addEventListener('click',()=>{ if(STATE.simulation) STATE.simulation.alpha(0.4).restart(); });
  qs('#fitView').addEventListener('click', ()=>fitToView());
  qs('#zoomInBtn').addEventListener('click', ()=>zoomBy(1.25));
  qs('#zoomOutBtn').addEventListener('click', ()=>zoomBy(0.8));
  qs('#zoomResetBtn').addEventListener('click', ()=>{
    STATE.transform=d3.zoomIdentity;
    d3.select('#viz').transition().duration(400).call(STATE.zoom.transform,STATE.transform);
  });
  qs('#searchNode').addEventListener('input',e=>{
    const v=e.target.value.trim().toLowerCase();
    if(!v){ highlightNode(null); return; }
    const m=STATE.graph.nodes.find(n=>n.id.toLowerCase().includes(v));
    if(m) highlightNode(m.id);
  });
  qs('#includeNonCore').addEventListener('change',()=>setStatus('Include Non-Core changed (re-visualize to apply)'));
  setStatus('Ready. Load solutions.');
});
</script>
</body>
</html>