<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Sentinel Solution Visualizer</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="description" content="Visualize Microsoft Sentinel solution artifacts, architecture, and dependencies." />
<style>
:root {
  --bg:#f8fafc; --panel:#ffffff; --panel-border:#e2e8f0; --text:#1e293b; --text-dim:#475569;
  --accent:#2563eb; --accent-strong:#1d4ed8; --muted:#94a3b8; --panel-muted:#f1f5f9;
  --danger:#dc2626; --badge-bg:#eef2ff; --badge-text:#1d4ed8;
}
.dark {
  --bg:#0f172a; --panel:#1e293b; --panel-border:#334155; --text:#f1f5f9; --text-dim:#94a3b8;
  --accent:#3b82f6; --accent-strong:#1d4ed8; --muted:#64748b; --panel-muted:#243140;
  --badge-bg:#1e293b; --badge-text:#60a5fa;
}
html,body{height:100%;margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:var(--text);}
h1{margin:0;font-size:1.9rem;font-weight:700;letter-spacing:-.5px;}
.panel{background:var(--panel);border:1px solid var(--panel-border);border-radius:14px;}
.panel-header{font-size:.7rem;letter-spacing:.06em;font-weight:600;text-transform:uppercase;color:var(--text-dim);}
.badge{background:var(--badge-bg);color:var(--badge-text);padding:2px 6px;border-radius:6px;font-size:.6rem;font-weight:600;letter-spacing:.5px;}
.btn{background:var(--accent);color:#fff;padding:6px 14px;border-radius:8px;font-size:.7rem;font-weight:600;display:inline-flex;align-items:center;gap:4px;border:none;cursor:pointer;}
.btn:hover{background:var(--accent-strong);}
.btn-muted{background:var(--panel-muted);color:var(--text-dim);padding:6px 12px;border-radius:8px;font-size:.7rem;font-weight:600;border:none;cursor:pointer;}
.btn-muted:hover{background:var(--panel-border);color:var(--text);}
.input{background:var(--panel);border:1px solid var(--panel-border);border-radius:8px;padding:6px 8px;font-size:.72rem;width:100%;box-sizing:border-box;}
.input:focus{outline:2px solid var(--accent);outline-offset:1px;}
.toggle{display:inline-flex;align-items:center;gap:6px;font-size:.63rem;}
#viz{font:10px sans-serif;}
.graph-link{transition:stroke-width .18s, stroke-opacity .25s;}
.node-group rect{transition:filter .2s,stroke-width .2s;}
.node-group:hover rect{filter:brightness(1.07);}
.edge-label{font-size:.5rem;fill:var(--text-dim);pointer-events:none;user-select:none;}
#tooltip{pointer-events:none;z-index:60;min-width:220px;max-width:440px;line-height:1.15rem;font-size:.62rem;}
table.artifact-table{border-collapse:collapse;width:100%;font-size:.62rem;}
table.artifact-table th,table.artifact-table td{border:1px solid var(--panel-border);padding:4px 6px;text-align:left;}
table.artifact-table th{background:var(--panel-muted);font-weight:600;font-size:.58rem;cursor:pointer;}
.arch-highlight {display:inline-block;font-size:1.15rem;font-weight:700;padding:6px 14px;border-radius:10px;background:linear-gradient(90deg,#334155,#475569);color:#fff;letter-spacing:.5px;box-shadow:0 2px 6px rgba(0,0,0,.35);position:relative;animation:pulseArch 3.2s ease-in-out infinite;transition:transform .25s;}
.arch-highlight:hover {transform:scale(1.04);}
.arch-highlight.ccf {background:linear-gradient(90deg,#047857,#10b981);}
.arch-highlight.http {background:linear-gradient(90deg,#b45309,#f59e0b);}
.arch-highlight.unknown {background:linear-gradient(90deg,#64748b,#475569);}
@keyframes pulseArch {0%,100% { box-shadow:0 0 0 0 rgba(255,255,255,0.5); }50% { box-shadow:0 0 0 10px rgba(255,255,255,0); }}
.disclaimer{
  position:fixed;left:10px;bottom:10px;max-width:360px;font-size:11px;line-height:1.3;font-weight:500;
  color:#b91c1c;background:rgba(255,255,255,.9);border:1px solid #fca5a5;padding:6px 8px 7px;border-radius:6px;
  z-index:9999;backdrop-filter:blur(4px);
}
.dark .disclaimer{background:rgba(31,41,55,.75);color:#fecaca;border-color:#b91c1c;}
@media (max-width:640px){
  h1{font-size:1.4rem;}
  .disclaimer{font-size:10px;max-width:75%;}
}
</style>
</head>
<body class="p-4" style="padding:1.2rem;display:flex;flex-direction:column;gap:1.1rem;">

<div class="disclaimer">
  Heuristic tool: connector type (CCF vs HTTP), endpoints, flows, and architecture layers are bestâ€‘effort. Validate with official Sentinel documentation.
</div>

<header style="text-align:center;display:flex;flex-direction:column;gap:.4rem;">
  <h1>Sentinel Solution Visualizer</h1>
  <p id="status" style="margin:0;font-size:.75rem;color:var(--text-dim);">Ready.</p>
</header>

<section class="panel" style="padding:1.1rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;align-items:start;">
  <div>
    <label class="panel-header" style="display:block;margin-bottom:4px;">GitHub Repo</label>
    <input id="repoInput" class="input" value="Azure/Azure-Sentinel" />
  </div>
  <div>
    <label class="panel-header" style="display:block;margin-bottom:4px;">Branch</label>
    <input id="branchInput" class="input" value="master" />
  </div>
  <div>
    <label class="panel-header" style="display:block;margin-bottom:4px;">Solution</label>
    <select id="solutionSelect" class="input">
      <option value="">(Load solutions)</option>
    </select>
  </div>
  <div>
    <label class="panel-header" style="display:block;margin-bottom:4px;">GitHub PAT (optional)</label>
    <input id="tokenInput" class="input" type="password" placeholder="ghp_..." />
  </div>
  <div style="display:flex;flex-wrap:wrap;gap:.5rem;align-items:flex-end;">
    <button id="btnLoad" class="btn">Load Solutions</button>
    <button id="btnVisualize" class="btn">Visualize</button>
    <button id="btnReset" class="btn-muted">Reset</button>
    <button id="btnDark" class="btn-muted">Dark</button>
  </div>
  <div style="grid-column:1/-1;display:flex;flex-wrap:wrap;gap:.8rem;font-size:.63rem;align-items:center;">
    <label class="toggle"><input id="includeNonCore" type="checkbox" checked />Include Non-Core</label>
    <label class="toggle"><input id="showEdgeLabels" type="checkbox" />Edge Labels</label>
    <label class="toggle"><input id="degreeScaled" type="checkbox" />Scale by Degree</label>
    <div style="display:flex;align-items:center;gap:4px;">
      <span style="font-size:.55rem;font-weight:600;letter-spacing:.05em;">Layout:</span>
      <select id="layoutSelect" class="input" style="width:170px;font-size:.6rem;padding:4px 6px;">
        <option value="force">Force (banded)</option>
        <option value="radial">Radial Rings</option>
        <option value="grid">Grid by Type</option>
        <option value="architecture">Architecture (top-down)</option>
      </select>
    </div>
    <button id="btnExportJson" class="btn-muted" style="font-size:.6rem;">Export JSON</button>
    <button id="btnExportCsv" class="btn-muted" style="font-size:.6rem;">Export CSV</button>
    <button id="btnExportPng" class="btn-muted" style="font-size:.6rem;">Export PNG</button>
    <span id="rateLimit" style="margin-left:auto;color:var(--text-dim);"></span>
  </div>
</section>

<div style="display:grid;grid-template-columns:320px 1fr;gap:1.2rem;">
  <aside style="display:flex;flex-direction:column;gap:1rem;">
    <div class="panel" style="padding:1rem;display:flex;flex-direction:column;gap:.7rem;">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div class="panel-header">Filters & Search</div>
        <button id="resetFilters" class="btn-muted" style="font-size:.55rem;padding:4px 8px;">Reset</button>
      </div>
      <input id="nodeSearch" class="input" placeholder="Node search..." />
      <div id="filterTypes" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:.4rem;font-size:.6rem;"></div>
      <div style="display:flex;flex-wrap:wrap;gap:.4rem;">
        <button id="btnFit" class="btn-muted" style="flex:1;">Fit</button>
        <button id="btnRecenter" class="btn-muted" style="flex:1;">Recenter</button>
        <button id="btnClearHighlight" class="btn-muted" style="flex:1;">Clear</button>
      </div>
    </div>

    <div class="panel" style="padding:1rem;">
      <div class="panel-header" style="margin-bottom:.4rem;">Solution Meta</div>
      <div id="solutionMeta" style="font-size:.63rem;line-height:1.05rem;"></div>
    </div>

    <div class="panel" style="padding:1rem;">
      <div class="panel-header" style="margin-bottom:.4rem;">Design Overview</div>
      <div id="designOverview" style="font-size:.63rem;line-height:1.05rem;">(Visualize to populate.)</div>
    </div>

    <div class="panel" style="padding:1rem;">
      <div class="panel-header" style="margin-bottom:.4rem;">Selected Node</div>
      <div id="artifactMeta" style="font-size:.63rem;line-height:1.05rem;">Select a node.</div>
    </div>

    <div class="panel" style="padding:1rem;">
      <div class="panel-header" style="margin-bottom:.4rem;">Logic & Wizard Analysis</div>
      <div id="logicPanel" style="font-size:.63rem;line-height:1.05rem;">(Pending)</div>
    </div>

    <div class="panel" style="padding:1rem;">
      <div class="panel-header" style="margin-bottom:.4rem;">Legend</div>
      <div id="legend" style="font-size:.6rem;display:grid;gap:.25rem;"></div>
    </div>

    <div class="panel" style="padding:1rem;">
      <div class="panel-header" style="margin-bottom:.4rem;">Diagnostics</div>
      <div id="log" style="font-size:.55rem;font-family:monospace;max-height:160px;overflow:auto;line-height:1.05rem;"></div>
    </div>
  </aside>

  <main style="display:flex;flex-direction:column;gap:1.2rem;">
    <div class="panel" style="position:relative;height:900px;">
      <svg id="viz" style="width:100%;height:100%;"><g id="zoomLayer"></g></svg>
      <div id="tooltip" style="position:absolute;top:0;left:0;opacity:0;background:#0f172a;color:#fff;padding:6px 8px;border-radius:6px;box-shadow:0 4px 16px -4px rgba(0,0,0,.4);"></div>
      <div id="loadingOverlay" style="display:none;position:absolute;inset:0;background:rgba(255,255,255,.9);backdrop-filter:blur(3px);z-index:50;align-items:center;justify-content:center;flex-direction:column;gap:1rem;">
        <div style="width:46px;height:46px;border:4px solid var(--accent);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;"></div>
        <div id="loadingText" style="font-size:.7rem;font-weight:600;color:var(--text-dim);">Loading...</div>
      </div>
      <style>@keyframes spin{to{transform:rotate(360deg);}}</style>
      <div style="position:absolute;top:10px;right:10px;display:flex;flex-direction:column;gap:.4rem;">
        <button id="zoomIn" class="btn-muted" style="width:38px;height:38px;font-size:1rem;">+</button>
        <button id="zoomOut" class="btn-muted" style="width:38px;height:38px;font-size:1rem;">âˆ’</button>
        <button id="zoomReset" class="btn-muted" style="width:38px;height:38px;font-size:.7rem;">Reset</button>
      </div>
    </div>

    <div class="panel" style="padding:1rem;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.6rem;">
        <div class="panel-header">Artifact Explorer</div>
        <input id="artifactSearch" class="input" placeholder="Search artifacts..." style="max-width:240px;" />
      </div>
      <div id="artifactTypeQuick" style="display:flex;flex-wrap:wrap;gap:.4rem;margin-bottom:.5rem;"></div>
      <div style="max-height:340px;overflow:auto;">
        <table class="artifact-table">
          <thead>
            <tr>
              <th data-sort="type">Type</th>
              <th data-sort="id">ID / Name</th>
              <th data-sort="detail">Detail</th>
              <th data-sort="tables">Tables</th>
            </tr>
          </thead>
          <tbody id="artifactTableBody"></tbody>
        </table>
      </div>
    </div>
  </main>
</div>

<script>
/* ================= CONFIG & STATE ================= */
const CONFIG={D3_VERSION:'7.9.0',ENABLE_BRANCH_AUTODETECT:true,MAX_LOG_LINES:600};
const STATE={
  cache:new Map(),
  layoutMode:'force',
  includeNonCore:true,
  showEdgeLabels:false,
  degreeScaled:false,
  showIsolated:true,
  zoom:{x:0,y:0,k:1},
  highlighted:null,
  fetching:false,
  artifacts:null,
  fullGraph:null,
  graph:{nodes:[],links:[]},
  meta:null,
  createUiAnalysis:null,
  solutionAnalysis:null,
  simulation:null,
  dark:true
};
window.STATE=STATE;

/* ================= HELPERS ================= */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
function log(msg,err=false){
  const el=$('#log'); if(!el)return;
  const ts=new Date().toISOString().split('T')[1].replace('Z','');
  const line=document.createElement('div');
  line.textContent=`[${ts}] ${msg}`;
  line.style.color=err?'#dc2626':'var(--text-dim)';
  el.appendChild(line);
  while(el.children.length>CONFIG.MAX_LOG_LINES) el.removeChild(el.firstChild);
  el.scrollTop=el.scrollHeight;
}
function setStatus(m,err=false){ const s=$('#status'); if(s){s.textContent=m; s.style.color=err?'var(--danger)':'var(--text-dim)';} log(m,err); }
function escapeHtml(str){ if(str==null)return''; return String(str).replace(/[&<>\"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);} }
function toggleLoader(on,text='Loading...'){ $('#loadingOverlay').style.display=on?'flex':'none'; $('#loadingText').textContent=text; }

/* ================= D3 LOADING ================= */
function ensureD3(){return !!window.d3;}
(function loadD3(){
  if(ensureD3())return;
  const s=document.createElement('script');
  s.src=`https://cdnjs.cloudflare.com/ajax/libs/d3/${CONFIG.D3_VERSION}/d3.min.js`;
  s.onload=()=>log('D3 loaded');
  s.onerror=()=>log('D3 failed to load',true);
  document.head.appendChild(s);
})();

/* ================= GITHUB FETCHERS ================= */
function ghHeaders(){
  const t=$('#tokenInput')?.value.trim();
  const h={'Accept':'application/vnd.github+json'};
  if(t) h.Authorization=`token ${t}`;
  return h;
}
function updateRateLimit(res){
  if(!res?.headers)return;
  const rem=res.headers.get('x-ratelimit-remaining');
  const lim=res.headers.get('x-ratelimit-limit');
  const reset=res.headers.get('x-ratelimit-reset');
  if(rem && lim){
    $('#rateLimit').textContent=`Rate: ${rem}/${lim}${reset?` (reset ${new Date(+reset*1000).toLocaleTimeString()})`:''}`;
  }
}
async function fetchJson(url,purpose='',tries=3){
  if(STATE.cache.has(url)) return STATE.cache.get(url);
  for(let i=1;i<=tries;i++){
    try{
      const res=await fetch(url,{headers:ghHeaders()});
      updateRateLimit(res);
      if(!res.ok) throw new Error(`HTTP ${res.status} ${purpose} @ ${url}`);
      const j=await res.json(); STATE.cache.set(url,j); return j;
    }catch(e){
      log(`Retry ${i}/${tries} ${purpose}: ${e.message}`,true);
      if(i===tries) throw e;
      await new Promise(r=>setTimeout(r,350*i));
    }
  }
}

/* Primary listing with fallback */
async function listSolutionJsonPaths(owner,repo,branch,solution){
  try{
    const b=await fetch(`https://api.github.com/repos/${owner}/${repo}/branches/${encodeURIComponent(branch)}`,{headers:ghHeaders()});
    updateRateLimit(b); if(!b.ok) throw new Error(`Branch lookup failed ${b.status}`);
    const bj=await b.json(); const sha=bj?.commit?.commit?.tree?.sha;
    if(!sha) throw new Error('Missing tree SHA');
    const tUrl=`https://api.github.com/repos/${owner}/${repo}/git/trees/${sha}?recursive=1`;
    const t=await fetch(tUrl,{headers:ghHeaders()});
    updateRateLimit(t); if(!t.ok) throw new Error(`Tree fetch failed ${t.status}`);
    const tj=await t.json();
    const prefix=`Solutions/${solution}/`;
    const paths=(tj.tree||[])
      .filter(n=>n.type==='blob' && n.path.startsWith(prefix) && n.path.toLowerCase().endsWith('.json'))
      .map(n=>n.path);
    if(!paths.length) throw new Error('No JSON via tree, fallback');
    return paths;
  }catch(err){
    log(`Primary enumeration failed: ${err.message}; fallback.`,true);
    return await listSolutionJsonPathsFallback(owner,repo,branch,solution);
  }
}
async function listSolutionJsonPathsFallback(owner,repo,branch,solution){
  const base=`https://api.github.com/repos/${owner}/${repo}/contents/Solutions/${encodeURIComponent(solution)}`;
  const out=[];
  async function walk(dir){
    const url=`${base}${dir?'/'+dir:''}?ref=${encodeURIComponent(branch)}`;
    const res=await fetch(url,{headers:ghHeaders()}); updateRateLimit(res);
    if(!res.ok) throw new Error(`Fallback contents failed ${res.status} @ ${url}`);
    const items=await res.json();
    for(const it of items){
      if(it.type==='dir') await walk(dir?`${dir}/${it.name}`:it.name);
      else if(it.type==='file' && it.name.toLowerCase().endsWith('.json'))
        out.push(`Solutions/${solution}${dir?'/'+dir:''}/${it.name}`);
    }
  }
  await walk('');
  return out;
}
async function detectDefaultBranch(owner,repo){
  try{
    const r=await fetch(`https://api.github.com/repos/${owner}/${repo}`,{headers:ghHeaders()});
    if(!r.ok)return null;
    const j=await r.json(); return j.default_branch;
  }catch{return null;}
}
async function listSolutions(owner,repo,branch){
  const r=await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/Solutions?ref=${encodeURIComponent(branch)}`,{headers:ghHeaders()});
  updateRateLimit(r); if(!r.ok) throw new Error(`Solutions list failed: ${r.status}`);
  const j=await r.json();
  return (j||[]).filter(x=>x.type==='dir').map(x=>x.name).sort();
}

/* ================= QUERY & EXTRACTION HELPERS ================= */
function extractTablesFromQuery(q){
  if(!q) return [];
  // Broaden: custom tables (_CL, _CE, _CF), common built-ins, generic Events suffix
  const coreBuiltIns = [
    'CommonSecurityLog','Syslog','SecurityAlert','SecurityIncident','Heartbeat','AzureActivity',
    'SigninLogs','AuditLogs','OfficeActivity','ApplicationGatewayFirewallLog',
    'VMConnection','DnsEvents','DeviceEvents','DeviceNetworkEvents'
  ];
  const pattern = new RegExp(
    '\\b(' +
      coreBuiltIns.join('|') +
    '|[A-Za-z0-9_]+_(CL|CE|CF)' +
    '|[A-Za-z0-9]+Events?' +
    ')\\b','g');
  const set=new Set();
  for(const m of q.matchAll(pattern)){ set.add(m[1]); }
  return [...set];
}
function summarizeQueryMetrics(q){
  if(!q) return {lines:0,length:0};
  const lines=q.split(/\r?\n/).filter(l=>l.trim()).length;
  return {lines,length:q.length};
}
function extractEndpointsGeneric(json){
  const set=new Set();
  function walk(o){
    if(!o||typeof o!=='object')return;
    if(Array.isArray(o)){o.forEach(walk);return;}
    for(const k in o){
      const v=o[k];
      if(typeof v==='string'){
        if(/(endpoint|baseUrl|baseURL|url|host|apiRoot|apiEndpoint|tokenUrl|authUrl)$/i.test(k)) capture(v);
        const u=v.match(/https?:\/\/[^\s"'<>{}]+/g); if(u) u.forEach(capture);
      }else if(typeof v==='object') walk(v);
    }
  }
  function capture(u){
    if(!/^https?:\/\//i.test(u))return;
    try{ const host=new URL(u).host.toLowerCase(); if(host) set.add(host);}catch{}
  }
  walk(json);
  return [...set].slice(0,20);
}
function normalizeMetaList(input){
  if(input==null) return [];
  if(Array.isArray(input))
    return [...new Set(input.flatMap(v=>normalizeMetaList(v)).filter(s=>typeof s==='string'&&s.trim()).map(s=>s.trim()))];
  if(typeof input==='string')
    return input.split(/[,;]+/).map(s=>s.trim()).filter(Boolean);
  if(typeof input==='object'){
    const out=[];
    for(const [k,v] of Object.entries(input)){
      if(typeof v==='boolean' && v) out.push(k);
      else if(typeof v==='string' && v.trim()) out.push(v.trim());
      else if(Array.isArray(v)) out.push(...normalizeMetaList(v));
      else if(v && typeof v==='object'){
        const cand=['name','displayName','title','value','category','domain','id','label']
          .find(c=>typeof v[c]==='string'&&v[c].trim());
        if(cand) out.push(v[cand].trim()); else out.push(...normalizeMetaList(v));
      }
    }
    return [...new Set(out)];
  }
  return [];
}
function detectKindCategory(json){
  const k=(json?.kind||json?.properties?.kind||'').toLowerCase();
  const txt=JSON.stringify(json).toLowerCase();
  const hasUi=json?.properties?.connectorUiConfig||json?.properties?.connectorUIConfig;
  const hasDcr=json?.properties?.dcrConfig;
  if(/restapipoller|apipolling/.test(k)) return 'CCF â€“ API Poller';
  if(/codeless/.test(k)||hasUi) return 'CCF â€“ UI';
  if(hasDcr) return 'CCF â€“ DCR';
  if(/logs ingestion api/.test(txt)) return 'Logs Ingestion API';
  if(/azurefunction/.test(k)) return 'Azure Function';
  if(/http data collector|datacollector/.test(txt)||/datacollector/.test(k)) return 'HTTP Data Collector';
  if(/pollinterval|pollingfrequency/.test(txt)) return 'API Polling';
  return '';
}

/* ================= DCR FLOW NORMALIZER ================= */
function normalizeDcrFlows(rawFlows){
  if(!Array.isArray(rawFlows)) return [];
  return rawFlows.map((f,i)=>{
    const streams=[...(f.streams||[])].map(s=>String(s));
    const tf=f.transformKql||f.transformKQL||'';
    const transformLines=tf?tf.split(/\r?\n/).filter(l=>l.trim()).length:0;
    const transformChars=tf.length;
    const outputTables=new Set();
    if(tf){
      const into=tf.match(/into\s+table\s+([a-zA-Z0-9_]+)/gi);
      if(into) into.forEach(m=>{
        const t=m.split(/\s+/).pop();
        if(t) outputTables.add(t);
      });
    }
    if(Array.isArray(f.destinations)){
      f.destinations.forEach(d=>{
        if(typeof d==='string') outputTables.add(d);
        else if(d && typeof d==='object'){
          const n=d.table||d.name||d.id;
          if(n) outputTables.add(n);
        }
      });
    }
    return {
      id:`flow${i+1}`,
      index:i,
      streams,
      outputTables:[...outputTables],
      transformLines,
      transformChars,
      hasTransform:!!tf
    };
  });
}

/* ================= CLASSIFICATION ================= */

const DEBUG_CLASSIFY = false; // set true for verbose classification logging

function isAnalyticRule(json){
  if(!json || typeof json!=='object') return false;
  const p=json.properties||{};
  const kind=(json.kind||p.kind||'').toLowerCase();
  const query=(p.query||'').trim();
  const hasQuery=query.length>10; // simple threshold
  const hasSeverity=!!p.severity;
  const hasTactics=Array.isArray(p.tactics) && p.tactics.length>0;
  const analyticKinds=new Set(['scheduled','nrt','fusion','anomaly','behavior','mlbehavioranalytics','microsoftsecurityincidentcreation']);
  const kindHit=[...analyticKinds].some(k=>kind.includes(k));
  return hasQuery && (hasSeverity || hasTactics || kindHit);
}

function classifyArtifact(json,path){
  const fileName=path.split('/').pop();
  const lower=fileName.toLowerCase();
  const lowerPath=path.toLowerCase();
  const text=JSON.stringify(json||{});
  const ltext=text.toLowerCase();
  const baseDisplay=json?.name||json?.displayName||json?.title||json?.properties?.displayName||fileName.replace(/\.json$/,'');

  /* Core file: mainTemplate */
  if(/main(template)?\.json$/i.test(fileName)){
    const resources=[];(function collect(a){ if(Array.isArray(a)) a.forEach(r=>{resources.push(r); if(Array.isArray(r?.resources)) collect(r.resources);});})(json.resources);
    let dc=0,ar=0,wb=0,pb=0,other=0;
    resources.forEach(r=>{
      const t=(r.type||'').toLowerCase();
      if(t.endsWith('/dataconnectors')) dc++;
      else if(t.includes('alertrules')) ar++;
      else if(t.endsWith('/workbooks')) wb++;
      else if(t.endsWith('/workflows')) pb++;
      else other++;
    });
    return {type:'filecore',id:'mainTemplate.json',path,raw:json,coreKind:'mainTemplate',
      resourceCounts:{total:resources.length,dataConnectors:dc,analyticRules:ar,workbooks:wb,playbooks:pb,others:other},
      endpoints:extractEndpointsGeneric(json)};
  }
  if(lower==='solutionmetadata.json'){
    return {type:'filecore',id:'solutionMetadata.json',path,raw:json,coreKind:'solutionMetadata',
      contentHubId:json.contentHubId||'',version:json.version||'',listingId:json.listingId||'',
      offerId:json.offerId||json.offerID||json.marketplaceOfferId||'',
      categories:normalizeMetaList(json.categories||json.category),
      domains:normalizeMetaList(json.domains||json.domain), endpoints:[]};
  }
  if(lower==='createuidefinition.json'){
    const steps=(text.match(/"steps"\s*:/gi)||[]).length;
    const params=(text.match(/"parameters"\s*:/gi)||[]).length;
    return {type:'filecore',id:'createUiDefinition.json',path,raw:json,coreKind:'createUiDefinition',
      stepsCount:steps,parametersCount:params,endpoints:extractEndpointsGeneric(json)};
  }
  if(lower==='pollerconfig.json'){
    const schedule=json.schedule||json.pollInterval||json.frequency||json.interval||'';
    return {type:'filecore',id:'pollerConfig.json',path,raw:json,coreKind:'pollerConfig',
      schedule: typeof schedule==='object'?JSON.stringify(schedule):String(schedule||''),endpoints:extractEndpointsGeneric(json)};
  }
  if(lower==='dcr.json'){
    const flows=json?.properties?.dataFlows||json?.dataFlows||[];
    const flowsData=normalizeDcrFlows(flows);
    const streams=new Set(); flows.forEach(f=>(f.streams||[]).forEach(s=>streams.add(s)));
    return {type:'filecore',id:'dcr.json',path,raw:json,coreKind:'dcr',
      dataFlows:flows.length,streamCount:streams.size,flowsData,endpoints:extractEndpointsGeneric(json)};
  }
  if(lower==='host.json'||lower==='functionapp.json'){
    return {type:'functioninfra',id:fileName,path,raw:json,bindingsCount:text.length,endpoints:extractEndpointsGeneric(json)};
  }
  if(lower==='azuredeploy.json'){
    return {type:'deployment',id:'azuredeploy.json',path,raw:json,
      resourceCount:Array.isArray(json?.resources)?json.resources.length:0,endpoints:extractEndpointsGeneric(json)};
  }

  /* Watchlists */
  if(/\/watchlists\//i.test(lowerPath) || /"microsoft\.securityinsights\/watchlists"/.test(ltext)){
    return {type:'watchlist',id:baseDisplay,path,raw:json,description:json?.properties?.description||''};
  }

  /* KQL functions / parsers */
  if(/\/parsers\//i.test(lowerPath) || /\/functions\//i.test(lowerPath) || /"functionalias"|\"parsertype\"/i.test(ltext)){
    const kql=json?.properties?.query||json?.query||json?.kql||'';
    return {type:'kqlfunction',id:baseDisplay,path,raw:json,tables:extractTablesFromQuery(kql),queryMetrics:summarizeQueryMetrics(kql)};
  }

  /* Notebooks */
  if(/\/notebooks?\//i.test(lowerPath) && /"cells":\s*\[/.test(ltext)){
    return {type:'notebook',id:baseDisplay,path,raw:json,cellCount:(json.cells||[]).length};
  }

  /* Workbooks */
  if(lowerPath.includes('/workbooks/') || /"microsoft\.insights\/workbooks"/.test(ltext) || (/"workbook"/.test(ltext)&&json?.properties?.serializedData)){
    const query=json?.properties?.query||json?.query||'';
    return {type:'workbook',id:baseDisplay,path,raw:json,description:json?.properties?.description||'',
      tables:extractTablesFromQuery(query),queryMetrics:summarizeQueryMetrics(query)};
  }

  /* Analytics rules */
    const analyticPathHint =
    /\/analytic[s]?[ _-]?rules?\//i.test(lowerPath) ||
    /\/alert[ _-]?rules?\//i.test(lowerPath) ||
    /\/detection[s]?\//i.test(lowerPath) ||
    /\/alertrules\//i.test(lowerPath);

  if( analyticPathHint || isAnalyticRule(json) ){
    const p=json.properties||{};
    const query=p.query||json.query||'';
    const severity=p.severity||json.severity||'';
    const tactics=(p.tactics||json.tactics||[]).join(', ');
    if(DEBUG_CLASSIFY){
      log(`AnalyticRule detected: path=${path} queryLen=${query.length} severity=${severity} tacticsRawLen=${(p.tactics||[]).length}`);
    }
    return {
      type:'analyticrule',
      id: p.displayName || json.displayName || baseDisplay,
      path,
      raw:json,
      tables: extractTablesFromQuery(query),
      severity,
      tactics,
      queryMetrics: summarizeQueryMetrics(query)
    };
  }

  /* Hunting queries */
  if(/\/hunting queries\//.test(lowerPath)||/\/huntingqueries\//.test(lowerPath)||(json?.tags && json.tags['hidden-sentinelContentType']==='HuntingQuery')){
    const query=json?.properties?.query||json?.query||'';
    return {type:'huntingquery',id:baseDisplay,path,raw:json,tables:extractTablesFromQuery(query),queryMetrics:summarizeQueryMetrics(query)};
  }

  /* Playbooks */
  if(/\/playbooks\//.test(lowerPath)||(json?.definition||json?.properties?.definition)){
    const wf=json?.definition||json?.properties?.definition;
    return {type:'playbook',id:baseDisplay,path,raw:json,
      triggers: wf?.triggers?Object.keys(wf.triggers).length:0,
      actions: wf?.actions?Object.keys(wf.actions).length:0};
  }

  /* DCR-like dependency (non core dcr.json) */
  if(lower!=='dcr.json' && (/microsoft\.insights\/datacollectionrules/.test(ltext) || json?.properties?.dataFlows || json?.dataFlows)){
    const flows=json?.properties?.dataFlows||json?.dataFlows||[];
    const flowsData=normalizeDcrFlows(flows);
    const tables=new Set(), streams=new Set();
    flows.forEach(f=>{
      (f.streams||[]).forEach(s=>streams.add(String(s).toLowerCase()));
      const tf=f.transformKql||f.transformKQL||'';
      const into=tf.match(/into\s+table\s+([a-z0-9_]+)/ig);
      if(into) into.forEach(m=>{
        const t=m.split(/\s+/).pop();
        if(t) tables.add(t.toLowerCase());
      });
    });
    flowsData.forEach(fd=>fd.outputTables.forEach(t=>tables.add(t.toLowerCase())));
    return {
      type:'dependency',
      id:baseDisplay,
      path,
      raw:json,
      dataFlows:flows.length,
      tables:[...tables].sort(),
      streams:[...streams].sort(),
      flowsData,
      endpoints:extractEndpointsGeneric(json)
    };
  }

  /* Refined connector heuristic */
  const rawKind=(json?.kind||json?.properties?.kind||'').toLowerCase();
  const uiCfg=json?.properties?.connectorUiConfig||json?.properties?.connectorUIConfig;
  const dcrCfg=json?.properties?.dcrConfig;
  const hasDcr=!!dcrCfg;
  const hasDataTypes=Array.isArray(json?.properties?.dataTypes);
  const isConnectorFolder=/\/data[ _-]?connectors?\//i.test(lowerPath);
  const allowedConnectorPath=/Solutions\/[^/]+\/Data[ _-]?Connectors\//i.test(path);
  const httpSignals=/(workspaceid.+sharedkey|x-ms-signature|opinsights\.azure\.com|api\/logs\?)/i.test(ltext);
  const strongStructure=uiCfg && hasDcr;

  let ingestionType='Other';
  if(hasDcr) ingestionType='CCF-DCR';
  else if(uiCfg && /codeless|apipolling|restapipoller/.test(rawKind)) ingestionType='CCF-UI';
  else if(httpSignals) ingestionType='HTTP Data Collector';

  const connectorStrong=
    ((isConnectorFolder && allowedConnectorPath) && (uiCfg||hasDcr||hasDataTypes)) ||
    strongStructure ||
    (uiCfg && (hasDcr||hasDataTypes)) ||
    (uiCfg && /codeless|apipolling|restapipoller/.test(rawKind)) ||
    (httpSignals && uiCfg);

  if(connectorStrong){
    if(allowedConnectorPath || strongStructure){
      const tables=hasDataTypes?json.properties.dataTypes.map(dt=>dt?.name||dt).filter(Boolean):[];
      const streams=[];
      if(dcrCfg?.streamDeclarations) dcrCfg.streamDeclarations.forEach(s=>s?.streamName&&streams.push(s.streamName));
      const desc=uiCfg?.description||json?.properties?.description||'';
      const publisher=uiCfg?.publisher||json?.properties?.publisher||json?.properties?.author||'';
      const domain=uiCfg?.domain||json?.properties?.domain||'';
      const metricNames=Array.isArray(uiCfg?.graphQueries)?[...new Set(uiCfg.graphQueries.map(g=>g?.metricName).filter(Boolean))]:[];
      return {
        type:'connector',
        id:uiCfg?.title||uiCfg?.displayName||baseDisplay,
        path,
        raw:json,
        mechanism:ingestionType,
        ingestionType,
        kindCategory: ingestionType==='HTTP Data Collector'?'HTTP Data Collector':detectKindCategory(json),
        tables:[...new Set(tables)],
        streams:[...new Set(streams)],
        description:desc,
        publisher,domain,metricNames,
        endpoints:extractEndpointsGeneric(json)
      };
    }
  }

  /* Fallback generic */
  return {type:'json',id:baseDisplay,path,raw:json};
}

/* Connector dedupe */
function dedupeConnectors(list){
  if(!Array.isArray(list)||list.length<=1) return list;
  function canonicalKey(c){
    const rawId=(c.raw?.properties?.connectorId)||c.id||'';
    return rawId.toLowerCase()
      .replace(/\(.*?\)/g,'')
      .replace(/connector|integration|data$/g,'')
      .replace(/[\s._-]+/g,'')
      .replace(/v\d+$/,'');
  }
  function score(c){
    const rank=c.ingestionType==='CCF-DCR'?4:c.ingestionType==='CCF-UI'?3:c.ingestionType==='HTTP Data Collector'?2:1;
    const richness=(c.tables?.length||0)+(c.streams?.length||0);
    const penalty=/sample|test|old|deprecated|legacy/i.test(c.path||'')?-3:0;
    return rank*10+richness+penalty-(c.path||'').length/500;
  }
  function jaccard(a,b){
    if(!a.size && !b.size) return 1;
    let inter=0; a.forEach(v=>{if(b.has(v)) inter++;});
    const uni=a.size+b.size-inter;
    return uni? inter/uni:0;
  }
  const groups=[...list.reduce((m,c)=>{
    const k=canonicalKey(c);
    if(!m.has(k)) m.set(k,[]);
    m.get(k).push(c);
    return m;
  },new Map()).entries()];
  const out=[];
  groups.forEach(([key,arr])=>{
    if(arr.length===1){ out.push(arr[0]); return; }
    arr.sort((a,b)=>score(b)-score(a));
    const primary=arr[0];
    const primarySet=new Set([...(primary.tables||[]),...(primary.streams||[])].map(s=>s.toLowerCase()));
    out.push(primary);
    for(let i=1;i<arr.length;i++){
      const cand=arr[i];
      const candSet=new Set([...(cand.tables||[]),...(cand.streams||[])].map(s=>s.toLowerCase()));
      const sim=jaccard(primarySet,candSet);
      if(sim>=0.7){
        log(`Dedup connector: dropping "${cand.id}" similarity ${sim.toFixed(2)}`);
      }else{
        out.push(cand);
      }
    }
  });
  return out;
}

/* Build artifacts bucket */
function buildArtifacts(files){
  const acc={
    connectors:[],dcrs:[],workbooks:[],analytics:[],hunting:[],playbooks:[],
    watchlists:[],functions:[],notebooks:[],
    infra:[],deploy:[],others:[],coreFiles:[]
  };
  files.forEach(f=>{
    const c=classifyArtifact(f.json,f.path);
    if(!c){ log('Classifier undefined for '+f.path,true); return; }
    switch(c.type){
      case 'connector':acc.connectors.push(c);break;
      case 'dependency':acc.dcrs.push(c);break;
      case 'workbook':acc.workbooks.push(c);break;
      case 'analyticrule':acc.analytics.push(c);break;
      case 'huntingquery':acc.hunting.push(c);break;
      case 'playbook':acc.playbooks.push(c);break;
      case 'watchlist':acc.watchlists.push(c);break;
      case 'kqlfunction':acc.functions.push(c);break;
      case 'notebook':acc.notebooks.push(c);break;
      case 'functioninfra':acc.infra.push(c);break;
      case 'deployment':acc.deploy.push(c);break;
      case 'filecore':acc.coreFiles.push(c);break;
      default:acc.others.push(c);
    }
  });
  acc.connectors=dedupeConnectors(acc.connectors);

  const dcrNamesLower=new Map(acc.dcrs.map(d=>[d.id.toLowerCase(),d.id]));
  acc.connectors.forEach(c=>{
    const txt=JSON.stringify(c.raw).toLowerCase();
    c.linkedDcrIds=[];
    dcrNamesLower.forEach((orig,low)=>{ if(txt.includes(low)) c.linkedDcrIds.push(orig); });
  });
  return acc;
}

/* Harvest embedded content (mainTemplate) */
function harvestEmbeddedArtifacts(artifacts){
  const mt=artifacts.coreFiles.find(c=>c.coreKind==='mainTemplate');
  if(!mt||!mt.raw) return;
  const resources=Array.isArray(mt.raw.resources)?mt.raw.resources:[];
  const exists=(arr,id)=>arr.some(x=>x.id===id);
  resources.forEach(r=>{
    const t=(r.type||'').toLowerCase();
    if(/workbooks$/.test(t)){
      const id=r.name?.split('/').pop()||r.properties?.displayName||'Workbook';
      if(!exists(artifacts.workbooks,id)){
        const query=r.properties?.query||'';
        artifacts.workbooks.push({type:'workbook',id,path:'(embedded mainTemplate)',raw:r,
          description:r.properties?.description||'',tables:extractTablesFromQuery(query),
          queryMetrics:summarizeQueryMetrics(query)});
      }
    }
    if(/alertrules$/.test(t)){
      const props=r.properties||{}; const query=props.query||'';
      const id=props.displayName||r.name?.split('/').pop()||'AnalyticRule';
      if(!exists(artifacts.analytics,id)){
        artifacts.analytics.push({type:'analyticrule',id,path:'(embedded mainTemplate)',raw:r,
          severity:props.severity||'',tactics:(props.tactics||[]).join(', '),
          tables:extractTablesFromQuery(query),queryMetrics:summarizeQueryMetrics(query)});
      }
    }
    if(/watchlists$/.test(t)){
      const id=r.name?.split('/').pop()||r.properties?.displayName||'Watchlist';
      if(!exists(artifacts.watchlists,id)){
        artifacts.watchlists.push({type:'watchlist',id,path:'(embedded mainTemplate)',raw:r,
          description:r.properties?.description||''});
      }
    }
    if(t.endsWith('/savedsearches') && r.properties?.category==='Function'){
      const id=r.properties?.displayName||r.name?.split('/').pop()||'Function';
      if(!exists(artifacts.functions,id)){
        const kql=r.properties?.query||'';
        artifacts.functions.push({type:'kqlfunction',id,path:'(embedded mainTemplate)',raw:r,
          tables:extractTablesFromQuery(kql),queryMetrics:summarizeQueryMetrics(kql)});
      }
    }
  });
}

/* ================= META & ANALYSIS ================= */
function deriveSolutionId(solutionFolder,sm={},mt={}){
  const guid=/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i;
  const keys=['contentHubId','solutionId','solutionID','listingId','id','offerId','offerID','solutionUniqueId','packageId','contentId','packageID','contentID'];
  const direct=keys.map(k=>sm[k]).find(v=>typeof v==='string'&&v.trim());
  if(direct) return direct.trim();
  const ser=JSON.stringify(sm); const g=ser.match(guid); if(g) return g[0];
  const params=mt.parameters||{};
  for(const [k,v] of Object.entries(params)){
    if(/solution/i.test(k)&&/(id|guid)/i.test(k)){
      const dv=v?.defaultValue||v;
      if(typeof dv==='string'){
        const m=dv.match(guid); return m?m[0]:dv.trim();
      }
    }
  }
  if(sm.offerId) return sm.offerId;
  return solutionFolder;
}
async function extractSolutionMeta(owner,repo,branch,solution,paths){
  const base=`https://raw.githubusercontent.com/${owner}/${repo}/${encodeURIComponent(branch)}/`;
  const mtPath=paths.find(p=>/main(template)?\.json$/i.test(p));
  const smPath=paths.find(p=>/solutionmetadata\.json$/i.test(p));
  let mt={}, sm={};
  if(mtPath) mt=await fetchJson(base+mtPath,'mainTemplate')||{};
  if(smPath) sm=await fetchJson(base+smPath,'solutionMetadata')||{};

  function paramPick(...cands){
    for(const cand of cands){
      const seg=cand.split('.'); let cur=mt;
      for(const s of seg){ cur=cur?cur[s]:undefined; }
      if(typeof cur==='string'&&cur.trim()) return cur.trim();
      if(cur && typeof cur==='object' && typeof cur.defaultValue==='string') return cur.defaultValue.trim();
    }
    return '';
  }
  const solutionName=sm.name||sm.displayName||sm.solutionName||
    paramPick('parameters.SolutionName','parameters.solutionName','parameters.solution','parameters.name')||
    solution;
  const publisher=sm.publisherName||sm.publisher||sm.publisherId||
    paramPick('parameters.Publisher','parameters.publisher','parameters.publisherName')||'Unknown';
  const offerId=sm.offerId||sm.offerID||sm.marketplaceOfferId||'';
  const categories=normalizeMetaList(sm.categories||sm.category);
  const domains=normalizeMetaList(sm.domains||sm.domain);
  const solutionId=deriveSolutionId(solution,sm,mt);
  const resources=[];(function collect(a){ if(Array.isArray(a)) a.forEach(r=>{resources.push(r); if(Array.isArray(r.resources)) collect(r.resources);});})(mt.resources);
  let dc=0,ar=0,wb=0,pb=0,others=0;
  resources.forEach(r=>{
    const t=(r.type||'').toLowerCase();
    if(t.endsWith('/dataconnectors')) dc++;
    else if(t.includes('alertrules')) ar++;
    else if(t.endsWith('/workbooks')) wb++;
    else if(t.endsWith('/workflows')) pb++;
    else others++;
  });
  return {
    solutionName,solutionId,publisher,offerId,categories,domains,
    mainTemplateResourceCounts:{total:resources.length,dataConnectors:dc,analyticRules:ar,workbooks:wb,playbooks:pb,others},
    rawSolutionMeta:sm
  };
}

/* === New Architecture Determination (Rule-based) ===
   CCF vs Legacy vs Unknown following user-specified priority:
   1) RestApiPoller kind in mainTemplate => CCF
   2) pollerConfig.json + dcr.json => CCF
   3) AzureFunction or DataCollector kind in mainTemplate => Legacy
   4) host.json + functionApp.json => Legacy
   Else => Unknown
*/
function analyzeSolutionArchitecture(art){
  const strongCcf = new Set();
  const weakCcf   = new Set();
  const strongHttp= new Set();

  // Core files + embedded resources
  (art.coreFiles||[]).forEach(cf=>{
    const raw = cf.raw || {};
    const resources = [];
    (function collect(r){
      if(Array.isArray(r)) r.forEach(x=>{
        resources.push(x);
        if(Array.isArray(x.resources)) collect(x.resources);
      });
    })(raw.resources);

    resources.forEach(r=>{
      const t = (r.type||'').toLowerCase();
      if(t === 'microsoft.insights/datacollectionrules'){ strongCcf.add('dcr-resource'); }
      else if(t === 'microsoft.insights/datacollectionendpoints'){ strongCcf.add('dce-resource'); }
      else if(t.endsWith('/datacollectionruleassociations')) strongCcf.add('dcr-assoc');
      else if(t.endsWith('/dataconnectors')) weakCcf.add('dataconnectors-resource');
    });

    const paramsTxt = JSON.stringify(raw.parameters||{}).toLowerCase();
    if(paramsTxt.includes('workspaceid') && paramsTxt.includes('sharedkey')){
      strongHttp.add('params-workspace-sharedkey');
    }
  });

  // Standalone DCR JSON files counted as strong CCF
  if((art.dcrs||[]).length) strongCcf.add('dcr-file');

  // Poller config presence
  if((art.coreFiles||[]).some(f=>f.coreKind === 'pollerConfig')) strongCcf.add('poller-config');

  // Connectors
  (art.connectors||[]).forEach(c=>{
    const raw = c.raw || {};
    const txt = JSON.stringify(raw).toLowerCase();
    const kindCat = ((c.kindCategory||'') + ' ' + (c.mechanism||'')).toLowerCase();

    const hasDcrConfig    = !!raw?.properties?.dcrConfig;
    const hasUiConfig     = !!(raw?.properties?.connectorUiConfig||raw?.properties?.connectorUIConfig);
    const hasDataTypes    = Array.isArray(raw?.properties?.dataTypes) && raw.properties.dataTypes.length>0;
    const hasGraphQueries = Array.isArray(raw?.properties?.graphQueries) && raw.properties.graphQueries.length>0;

    if(hasDcrConfig) strongCcf.add('dcrConfig');
    if(/restapipoller|apipolling/.test(kindCat)) strongCcf.add('restApiPoller');

    // Codeless full package
    if(hasDcrConfig && hasUiConfig && hasDataTypes && hasGraphQueries){
      strongCcf.add('codeless-full');
    } else if(!hasDcrConfig && (hasUiConfig || /codeless/.test(kindCat))){
      weakCcf.add('ui-or-codeless-no-dcr');
    }

    // HTTP signals
    if(!hasDcrConfig && /workspaceid/.test(txt) && /sharedkey/.test(txt)) strongHttp.add('workspace-sharedkey');
    if(/\/api\/logs\?/.test(txt)) strongHttp.add('api-logs');
    if(/x-ms-date/.test(txt) && /x-ms-signature/.test(txt)) strongHttp.add('sig-headers');
    if(/http data collector|datacollector/.test(kindCat)) strongHttp.add('http-kind');
    if(/azurefunction/.test(kindCat)) strongHttp.add('azure-function-kind');

    (c.endpoints||[]).forEach(ep=>{
      if(/ods\.opinsights|opinsights\.azure\.com|oms\./.test(ep)) strongHttp.add('opinsights-endpoint');
    });
  });

  // Function infra: treat presence as strong HTTP signal (legacy ingestion infra)
  if((art.infra||[]).length) strongHttp.add('function-infra');

  // SCORING
  const scStrong = strongCcf.size;
  const scWeak   = weakCcf.size;
  const shStrong = strongHttp.size;

  let type = '';
  if(scStrong >= 2){
    type = 'CCF';
  } else if(scStrong >= 1 && scWeak >= 2){
    type = 'CCF';
  } else if(scStrong === 0 && shStrong > 0){
    type = 'HTTP Data Collector API';
  } else if(scStrong === 1 && shStrong >= 2){
    type = 'HTTP Data Collector API';
  } else if(!type && shStrong >= 1){
    type = 'HTTP Data Collector API';
  } else {
    type = 'Unknown';
  }

  return {
    type,
    ccfStrongSignals: [...strongCcf].sort(),
    ccfWeakSignals:   [...weakCcf].sort(),
    httpSignals:      [...strongHttp].sort(),
    scoring: {
      ccfStrong: scStrong,
      ccfWeak: scWeak,
      httpStrong: shStrong
    }
  };
}

function analyzeCreateUiDefinition(json){
  if(!json||typeof json!=='object') return null;
  const ser=JSON.stringify(json);
  const steps=(ser.match(/"steps"/gi)||[]).length;
  const connectors=(ser.match(/dataconnector/gi)||[]).length;
  const workbooks=(ser.match(/workbook/gi)||[]).length;
  const analytics=(ser.match(/analytic/i)||[]).length;
  const hunting=(ser.match(/hunting/i)||[]).length;
  const playbooks=(ser.match(/playbook|logic app/i)||[]).length;
  const basic=json?.parameters?.basics||json?.parameters?.config?.basics||{};
  const name=basic?.label||basic?.displayName||json?.name||json?.label||'';
  const desc=basic?.description||json?.description||'';
  return {
    solutionName:name,
    description:desc,
    implied:{dataConnectors:connectors,workbooks,analyticRules:analytics,huntingQueries:hunting,playbooks},
    steps,
    raw:json
  };
}

/* ================= GRAPH MODELS ================= */
const TYPE_META={
  solution:{label:'Solution',color:'#d8581d'},
  connector:{label:'Connector',color:'#26a69a'},
  dependency:{label:'DCR',color:'#5fb56b'},
  dataflow:{label:'Data Flow',color:'#10b981'},
  filecore:{label:'Core File',color:'#0ea5e9'},
  table:{label:'Table',color:'#ff8a65'},
  stream:{label:'Stream',color:'#9575cd'},
  workbook:{label:'Workbook',color:'#ffb74d'},
  analyticrule:{label:'Analytic',color:'#e57373'},
  huntingquery:{label:'Hunting',color:'#6366f1'},
  playbook:{label:'Playbook',color:'#ec4899'},
  watchlist:{label:'Watchlist',color:'#0ea5e9'},
  kqlfunction:{label:'KQL Function',color:'#14b8a6'},
  notebook:{label:'Notebook',color:'#6366f1'},
  functioninfra:{label:'Function Infra',color:'#4b5563'},
  deployment:{label:'Deployment',color:'#64748b'},
  externalsystem:{label:'External System',color:'#0284c7'},
  endpoint:{label:'Endpoint',color:'#0891b2'},
  json:{label:'JSON',color:'#bdbdbd'}
};
const TYPE_ORDER=Object.keys(TYPE_META);
const EDGE_STYLE={
  'solution-corefile':{stroke:'#0284c7'},
  'solution-connector':{stroke:'#2563eb'},
  'solution-dcr':{stroke:'#0d9488'},
  'connector-dcr':{stroke:'#0f766e'},
  'connector-table':{stroke:'#c2410c'},
  'connector-stream':{stroke:'#6d28d9'},
  'dcr-table':{stroke:'#ea580c'},
  'dcr-flow':{stroke:'#059669'},
  'flow-table':{stroke:'#10b981'},
  'table-analytic':{stroke:'#991b1b'},
  'table-workbook':{stroke:'#92400e'},
  'table-hunting':{stroke:'#4338ca'},
  'solution-workbook':{stroke:'#d97706'},
  'solution-analytic':{stroke:'#b91c1c'},
  'solution-playbook':{stroke:'#be185d'},
  'solution-hunting':{stroke:'#4338ca'},
  'solution-infra':{stroke:'#334155'},
  'solution-deployment':{stroke:'#475569'},
  'solution-json':{stroke:'#64748b'},
  'system-endpoint':{stroke:'#0369a1'},
  'endpoint-connector':{stroke:'#0d9488'},
  'endpoint-dcr':{stroke:'#0f766e'},
  'solution-watchlist':{stroke:'#0891b2'},
  'solution-function':{stroke:'#0f766e'},
  'function-table':{stroke:'#0d9488'},
  'solution-notebook':{stroke:'#4f46e5'}
};

function buildDependencyGraph(art,solutionName){
  const nodes=[],links=[],idx=new Map();
  const add=(id,type,meta={})=>{
    if(!id) return;
    const key=type+'::'+id;
    if(!idx.has(key)){ const o={id,type,meta}; idx.set(key,o); nodes.push(o); } else Object.assign(idx.get(key).meta,meta);
  };
  const link=(s,t,e)=>{ if(!s||!t)return; if(!links.some(l=>l.source===s&&l.target===t&&l.edgeType===e)) links.push({source:s,target:t,edgeType:e}); };

  add(solutionName,'solution',{});

  /* Core files */
  art.coreFiles.forEach(cf=>{
    add(cf.id,'filecore',cf);
    link(solutionName,cf.id,'solution-corefile');
  });

  /* DCR dependencies */
  art.dcrs.forEach(d=>{
    add(d.id,'dependency',d);
    link(solutionName,d.id,'solution-dcr');
    if(Array.isArray(d.flowsData)){
      d.flowsData.forEach(fl=>{
        const flowId=`${d.id}::${fl.id}`;
        add(flowId,'dataflow',{parentDcr:d.id,...fl});
        link(d.id,flowId,'dcr-flow');
        (fl.outputTables||[]).forEach(tb=>{
          add(tb,'table',{}); link(flowId,tb,'flow-table');
        });
      });
    }
    (d.tables||[]).forEach(tb=>{ add(tb,'table',{}); link(d.id,tb,'dcr-table'); });
  });

  /* Core file direct dcr.json flows */
  art.coreFiles.filter(cf=>cf.coreKind==='dcr').forEach(cf=>{
    if(Array.isArray(cf.flowsData)){
      cf.flowsData.forEach(fl=>{
        const flowId=`${cf.id}::${fl.id}`;
        add(flowId,'dataflow',{parentDcr:cf.id,...fl});
        link(cf.id,flowId,'dcr-flow');
        (fl.outputTables||[]).forEach(tb=>{
          add(tb,'table',{}); link(flowId,tb,'flow-table');
        });
      });
    }
  });

  /* Connectors */
  art.connectors.forEach(c=>{
    add(c.id,'connector',c);
    link(solutionName,c.id,'solution-connector');
    (c.linkedDcrIds||[]).forEach(did=>link(c.id,did,'connector-dcr'));
    (c.tables||[]).forEach(tb=>{ add(tb,'table',{}); link(c.id,tb,'connector-table');});
    (c.streams||[]).forEach(st=>{ add(st,'stream',{}); link(c.id,st,'connector-stream');});
  });

  /* Functions */
  art.functions.forEach(f=>{
    add(f.id,'kqlfunction',f);
    link(solutionName,f.id,'solution-function');
    (f.tables||[]).forEach(tb=>{ add(tb,'table',{}); link(f.id,tb,'function-table');});
  });

  /* Workbooks / Analytics / Hunting / Playbooks / Watchlists / Notebooks */
  art.workbooks.forEach(w=>{
    add(w.id,'workbook',w); link(solutionName,w.id,'solution-workbook');
    (w.tables||[]).forEach(tb=>nodes.some(n=>n.id===tb)&&link(tb,w.id,'table-workbook'));
  });
  art.analytics.forEach(a=>{
    add(a.id,'analyticrule',a); link(solutionName,a.id,'solution-analytic');
    (a.tables||[]).forEach(tb=>nodes.some(n=>n.id===tb)&&link(tb,a.id,'table-analytic'));
  });
  art.hunting.forEach(h=>{
    add(h.id,'huntingquery',h); link(solutionName,h.id,'solution-hunting');
    (h.tables||[]).forEach(tb=>nodes.some(n=>n.id===tb)&&link(tb,h.id,'table-hunting'));
  });
  art.playbooks.forEach(p=>{ add(p.id,'playbook',p); link(solutionName,p.id,'solution-playbook'); });
  art.watchlists.forEach(w=>{ add(w.id,'watchlist',w); link(solutionName,w.id,'solution-watchlist'); });
  art.notebooks.forEach(n=>{ add(n.id,'notebook',n); link(solutionName,n.id,'solution-notebook'); });

  /* Infra / Deployment / Others */
  art.infra.forEach(f=>{ add(f.id,'functioninfra',f); link(solutionName,f.id,'solution-infra'); });
  art.deploy.forEach(d=>{ add(d.id,'deployment',d); link(solutionName,d.id,'solution-deployment'); });
  art.others.slice(0,60).forEach(o=>{ add(o.id,'json',o); link(solutionName,o.id,'solution-json'); });

  /* Solution counts meta */
  const solNode=nodes.find(n=>n.type==='solution');
  if(solNode){
    solNode.meta.counts={
      connectors:art.connectors.length,
      dcrs:art.dcrs.length,
      workbooks:art.workbooks.length,
      analytics:art.analytics.length,
      playbooks:art.playbooks.length,
      hunting:art.hunting.length,
      watchlists:art.watchlists.length,
      functions:art.functions.length,
      notebooks:art.notebooks.length,
      coreFiles:art.coreFiles.length
    };
  }

  /* Orphan injection */
  nodes.forEach(n=>{
    if(n.type==='solution') return;
    const hasEdge=links.some(l=>l.source===n.id||l.target===n.id);
    if(!hasEdge) links.push({source:solutionName,target:n.id,edgeType:'solution-json'});
  });
  return {nodes,links};
}

function buildArchitectureGraph(art,meta,analysis){
  const g={nodes:[],links:[]};
  const add=(id,type,metaObj={})=>{ if(!id) return; if(!g.nodes.some(n=>n.id===id)) g.nodes.push({id,type,meta:metaObj}); };
  const link=(s,t,e)=>{ if(!s||!t)return; if(!g.links.some(l=>l.source===s&&l.target===t&&l.edgeType===e)) g.links.push({source:s,target:t,edgeType:e}); };

  const root=meta?.solutionName||'Solution';
  add(root,'solution',{archType:analysis?.type});

  /* Endpoints & externals derived from connectors + DCR files */
  const endpointHosts=new Map();
  function collectEndpoints(list){
    (list||[]).forEach(a=> (a.endpoints||[]).forEach(ep=>{
      const h=ep.toLowerCase();
      if(!endpointHosts.has(h)) endpointHosts.set(h,{id:h,host:h,connectors:new Set(),dcrs:new Set()});
    }));
  }
  collectEndpoints(art.connectors);
  collectEndpoints(art.coreFiles.filter(cf=>cf.coreKind==='dcr'));
  collectEndpoints(art.dcrs);

  function rootDomain(host){
    const parts=host.split('.'); if(parts.length<=2) return host;
    return parts.slice(-2).join('.');
  }
  const externals=new Map();
  endpointHosts.forEach((_,host)=>{
    const rd=rootDomain(host);
    if(!externals.has(rd)) externals.set(rd,{id:rd,hosts:new Set()});
    externals.get(rd).hosts.add(host);
  });
  externals.forEach(sys=>add(sys.id,'externalsystem',{hostCount:sys.hosts.size}));
  endpointHosts.forEach(ep=>add(ep.id,'endpoint'));

  art.connectors.forEach(c=>{
    add(c.id,'connector',c); link(root,c.id,'solution-connector');
    (c.endpoints||[]).forEach(ep=>{
      const h=ep.toLowerCase();
      if(endpointHosts.has(h)){
        endpointHosts.get(h).connectors.add(c.id);
        link(h,c.id,'endpoint-connector');
      }
    });
    (c.tables||[]).forEach(tb=>{ add(tb,'table',{}); link(c.id,tb,'connector-table'); });
  });

  art.dcrs.forEach(d=>{
    add(d.id,'dependency',d); link(root,d.id,'solution-dcr');
    if(Array.isArray(d.flowsData)){
      d.flowsData.forEach(fl=>{
        const flowId=`${d.id}::${fl.id}`;
        add(flowId,'dataflow',{parentDcr:d.id,...fl});
        link(d.id,flowId,'dcr-flow');
        (fl.outputTables||[]).forEach(tb=>{ add(tb,'table',{}); link(flowId,tb,'flow-table'); });
      });
    }
    (d.tables||[]).forEach(tb=>{ add(tb,'table',{}); link(d.id,tb,'dcr-table'); });
  });

  art.coreFiles.filter(cf=>cf.coreKind==='dcr').forEach(cf=>{
    add(cf.id,'filecore',cf); link(root,cf.id,'solution-corefile');
    if(Array.isArray(cf.flowsData)){
      cf.flowsData.forEach(fl=>{
        const flowId=`${cf.id}::${fl.id}`;
        add(flowId,'dataflow',{parentDcr:cf.id,...fl});
        link(cf.id,flowId,'dcr-flow');
        (fl.outputTables||[]).forEach(tb=>{ add(tb,'table',{}); link(flowId,tb,'flow-table'); });
      });
    }
  });

  endpointHosts.forEach((ep,host)=>{
    const rd=rootDomain(host);
    link(rd,host,'system-endpoint');
  });
  externals.forEach(sys=>link(root,sys.id,'solution-json'));

  art.functions.forEach(f=>{
    add(f.id,'kqlfunction',f); link(root,f.id,'solution-function');
    (f.tables||[]).forEach(tb=>{ add(tb,'table',{}); link(f.id,tb,'function-table'); });
  });

  art.workbooks.forEach(w=>{ add(w.id,'workbook',w); link(root,w.id,'solution-workbook'); (w.tables||[]).forEach(tb=>g.nodes.some(n=>n.id===tb)&&link(tb,w.id,'table-workbook')); });
  art.analytics.forEach(a=>{ add(a.id,'analyticrule',a); link(root,a.id,'solution-analytic'); (a.tables||[]).forEach(tb=>g.nodes.some(n=>n.id===tb)&&link(tb,a.id,'table-analytic')); });
  art.hunting.forEach(h=>{ add(h.id,'huntingquery',h); link(root,h.id,'solution-hunting'); (h.tables||[]).forEach(tb=>g.nodes.some(n=>n.id===tb)&&link(tb,h.id,'table-hunting')); });
  art.playbooks.forEach(p=>{ add(p.id,'playbook',p); link(root,p.id,'solution-playbook'); });
  art.watchlists.forEach(w=>{ add(w.id,'watchlist',w); link(root,w.id,'solution-watchlist'); });
  art.notebooks.forEach(n=>{ add(n.id,'notebook',n); link(root,n.id,'solution-notebook'); });
  art.coreFiles.forEach(cf=>{ if(cf.coreKind!=='dcr') { add(cf.id,'filecore',cf); link(root,cf.id,'solution-corefile'); } });

  return g;
}

/* ================= RENDERING ================= */
let ZOOM_CTRL=null;
function setupZoom(){
  if(!ensureD3())return;
  const svg=d3.select('#viz');
  const zoom=d3.zoom().scaleExtent([0.08,5]).on('zoom',e=>{
    STATE.zoom=e.transform;
    d3.select('#zoomLayer').attr('transform',e.transform);
  });
  svg.call(zoom);
  return zoom;
}
function fitView(duration=600){
  if(!ensureD3())return;
  const nodes=STATE.graph.nodes; if(!nodes.length)return;
  const svgEl=$('#viz'); const w=svgEl.clientWidth, h=svgEl.clientHeight;
  const xs=nodes.map(n=>n.x||0), ys=nodes.map(n=>n.y||0);
  const minX=Math.min(...xs), maxX=Math.max(...xs);
  const minY=Math.min(...ys), maxY=Math.max(...ys);
  const dx=maxX-minX||10, dy=maxY-minY||10;
  const scale=Math.min(3,0.9/Math.max(dx/w,dy/h));
  const t=d3.zoomIdentity.translate((w/2)-(minX+dx/2)*scale,(h/2)-(minY+dy/2)*scale).scale(scale);
  d3.select('#viz').transition().duration(duration).call(ZOOM_CTRL.transform,t);
  STATE.zoom=t;
}

function buildTooltip(){
  const tip=d3.select('#tooltip');
  return {
    show(evt,d){
      const m=d.meta||{};
      const L=[];
      L.push(`<div><b>${(TYPE_META[d.type]?.label)||d.type}</b> â€“ ${escapeHtml(d.id)}</div>`);
      if(d.type==='solution' && m.counts){
        const c=m.counts;
        L.push(`<div><b>Artifacts:</b> Conn ${c.connectors} DCR ${c.dcrs} Fn ${c.functions} Wkb ${c.workbooks}</div>`);
      }
      if(d.type==='filecore'){
        if(m.coreKind==='mainTemplate'){
          const rc=m.resourceCounts||{};
            L.push(`<div><b>Resources:</b> ${rc.total} (DC:${rc.dataConnectors} AR:${rc.analyticRules} WB:${rc.workbooks} PB:${rc.playbooks})</div>`);
        }
        if(m.coreKind==='dcr') L.push(`<div><b>DCR Flows:</b> ${m.dataFlows||0} Streams:${m.streamCount||0}</div>`);
      }
      if(d.type==='dataflow'){
        L.push(`<div><b>Parent DCR:</b> ${escapeHtml(m.parentDcr||'')}</div>`);
        L.push(`<div><b>Streams:</b> ${(m.streams||[]).join(', ')||'â€”'}</div>`);
        if(m.outputTables?.length) L.push(`<div><b>Outputs:</b> ${m.outputTables.join(', ')}</div>`);
        L.push(`<div><b>Transform:</b> ${m.hasTransform?`${m.transformLines} lines`:'None'}</div>`);
      }
      if(d.type==='connector'){
        if(m.mechanism) L.push(`<div><b>Mechanism:</b> ${escapeHtml(m.mechanism)}</div>`);
        if(m.kindCategory) L.push(`<div><b>Kind:</b> ${escapeHtml(m.kindCategory)}</div>`);
        if(m.tables?.length) L.push(`<div><b>Tables:</b> ${m.tables.join(', ')}</div>`);
        if(m.endpoints?.length) L.push(`<div><b>Endpoints:</b> ${m.endpoints.join(', ')}</div>`);
      }
      if(['workbook','analyticrule','huntingquery'].includes(d.type)){
        if(m.queryMetrics) L.push(`<div><b>Query:</b> ${m.queryMetrics.lines} lines</div>`);
        if(m.tables?.length) L.push(`<div><b>Tables:</b> ${m.tables.join(', ')}</div>`);
        if(m.severity) L.push(`<div><b>Severity:</b> ${m.severity}</div>`);
      }
      if(d.type==='playbook') L.push(`<div><b>Triggers:</b> ${m.triggers||0} Actions:${m.actions||0}</div>`);
      if(d.type==='kqlfunction'){
        if(m.tables?.length) L.push(`<div><b>Tables:</b> ${m.tables.join(', ')}</div>`);
        if(m.queryMetrics) L.push(`<div><b>KQL:</b> ${m.queryMetrics.lines} lines</div>`);
      }
      if(d.type==='notebook' && m.cellCount!=null) L.push(`<div><b>Cells:</b> ${m.cellCount}</div>`);
      if(d.type==='externalsystem') L.push(`<div><b>Hosts:</b> ${m.hostCount||0}</div>`);
      if(d.type==='endpoint') L.push('<div>Endpoint host</div>');
      tip.html(L.join('')).style('left',(evt.clientX+14)+'px').style('top',(evt.clientY+14)+'px').style('opacity',1);
    },
    hide(){ tip.style('opacity',0); }
  };
}

const NODE_LABEL_CFG={maxLines:7,minWidth:120,maxWidth:280,lineChars:24};
function nodeLines(d){
  const m=d.meta||{};
  const lines=[];
  function trunc(s,max=40){ if(!s) return ''; return s.length<=max?s:s.slice(0,max-1)+'â€¦'; }
  if(d.type==='solution'){
    lines.push(trunc(d.id,38));
    if(m.counts){
      const c=m.counts;
      lines.push(`Conn:${c.connectors} DCR:${c.dcrs}`);
      lines.push(`Fn:${c.functions} Wkb:${c.workbooks}`);
      lines.push(`Anl:${c.analytics} Ply:${c.playbooks}`);
      lines.push(`Hnt:${c.hunting} Wl:${c.watchlists}`);
    }
  } else if(d.type==='filecore'){
    lines.push(m.coreKind==='mainTemplate'?'mainTemplate.json':trunc(d.id,48));
    if(m.coreKind==='dcr') lines.push(`Flows:${m.dataFlows||0}`);
    if(m.coreKind==='createUiDefinition') lines.push(`Steps:${m.stepsCount||0}`);
  } else if(d.type==='connector'){
    lines.push(trunc(d.id,42));
    if(m.mechanism) lines.push(trunc(m.mechanism,34));
    if(m.tables?.length) lines.push(`Tbl:${m.tables.slice(0,3).join(',')}${m.tables.length>3?'â€¦':''}`);
    if(m.endpoints?.length) lines.push(`EP:${m.endpoints.length}`);
  } else if(d.type==='dependency'){
    lines.push(trunc(d.id,42));
    if(m.dataFlows!==undefined) lines.push(`Flows:${m.dataFlows}`);
    if(m.tables?.length) lines.push(`Tbl:${m.tables.slice(0,3).join(',')}${m.tables.length>3?'â€¦':''}`);
  } else if(d.type==='dataflow'){
    lines.push(trunc((m.parentDcr?m.parentDcr.split(/[/\\]/).pop()+':':'')+d.id,46));
    if(m.streams?.length) lines.push(`Str:${m.streams.slice(0,3).join(',')}${m.streams.length>3?'â€¦':''}`);
    if(m.outputTables?.length) lines.push(`Out:${m.outputTables.slice(0,3).join(',')}${m.outputTables.length>3?'â€¦':''}`);
    lines.push(m.hasTransform?`Tx:${m.transformLines}L`:'Tx:none');
  } else if(['workbook','analyticrule','huntingquery'].includes(d.type)){
    lines.push(trunc(d.id,42));
    if(m.severity) lines.push(`Sev:${m.severity}`);
    if(m.tables?.length) lines.push(`Tbl:${m.tables.slice(0,3).join(',')}${m.tables.length>3?'â€¦':''}`);
  } else if(d.type==='playbook'){
    lines.push(trunc(d.id,42));
    lines.push(`T:${m.triggers||0} A:${m.actions||0}`);
  } else if(d.type==='kqlfunction'){
    lines.push(trunc(d.id,42));
    if(m.tables?.length) lines.push(`Tbl:${m.tables.slice(0,3).join(',')}${m.tables.length>3?'â€¦':''}`);
  } else if(d.type==='notebook'){
    lines.push(trunc(d.id,42));
    if(m.cellCount!=null) lines.push(`Cells:${m.cellCount}`);
  } else if(d.type==='externalsystem'){
    lines.push(trunc(d.id,42));
    lines.push(`Hosts:${m.hostCount||0}`);
  } else {
    lines.push(trunc(d.id,48));
  }
  const maxChars=NODE_LABEL_CFG.lineChars;
  const out=[];
  lines.forEach(l=>{
    if(l.length<=maxChars){ out.push(l); return; }
    let cur='';
    l.split(/\s+/).forEach(w=>{
      if((cur+w).length>maxChars){
        if(cur) out.push(cur.trim());
        cur=w+' ';
      }else cur+=w+' ';
    });
    if(cur.trim()) out.push(cur.trim());
  });
  return out.slice(0,NODE_LABEL_CFG.maxLines);
}

function renderGraph(preserve=false){
  if(!ensureD3())return;
  const nodes=STATE.graph.nodes, links=STATE.graph.links;
  const svg=d3.select('#viz'), layer=d3.select('#zoomLayer');
  layer.selectAll('*').remove();
  const w=svg.node().clientWidth||1400, h=svg.node().clientHeight||900;
  const tip=buildTooltip();

  const defs=layer.append('defs');
  defs.append('marker')
    .attr('id','arrow')
    .attr('viewBox','0 -5 10 10')
    .attr('refX',18).attr('refY',0)
    .attr('markerWidth',6).attr('markerHeight',6)
    .attr('orient','auto')
    .append('path').attr('d','M0,-5L10,0L0,5').attr('fill','#64748b');

  const linkG=layer.append('g').attr('class','links').selectAll('g').data(links).enter().append('g');
  const linkPath=linkG.append('path')
    .attr('class','graph-link')
    .attr('stroke',l=>EDGE_STYLE[l.edgeType]?.stroke||'#64748b')
    .attr('stroke-opacity',.55)
    .attr('stroke-width',1.3)
    .attr('fill','none')
    .attr('marker-end','url(#arrow)');
  let edgeLabels=null;
  if(STATE.showEdgeLabels){
    edgeLabels=linkG.append('text')
      .attr('class','edge-label')
      .attr('text-anchor','middle')
      .text(l=>l.edgeType);
  }

  const nodeG=layer.append('g').attr('class','nodes')
    .selectAll('g').data(nodes,d=>d.id).enter().append('g')
    .attr('class','node-group')
    .on('mouseover',tip.show)
    .on('mouseout',tip.hide)
    .on('click',(e,d)=>{
      highlightNode(d.id);
      STATE.highlighted=d.id;
      showArtifactDetails(d);
      tip.show(e,d);
    })
    .call(d3.drag()
      .on('start',(e,d)=>{ d.fx=d.x; d.fy=d.y; if(STATE.simulation) STATE.simulation.alphaTarget(.25).restart(); })
      .on('drag',(e,d)=>{ d.fx=e.x; d.fy=e.y; })
      .on('end',(e,d)=>{ if(STATE.simulation && STATE.layoutMode==='force'){ d.fx=null; d.fy=null; STATE.simulation.alphaTarget(0); }})
    );

  nodeG.each(function(d){
    const g=d3.select(this);
    const lines=nodeLines(d);
    const longest=lines.reduce((m,l)=>Math.max(m,l.length),0);
    const charPx=6.6;
    let width=Math.min(NODE_LABEL_CFG.maxWidth,Math.max(NODE_LABEL_CFG.minWidth,longest*charPx+26));
    const height=Math.max(44,lines.length*14+16);
    g.append('rect')
      .attr('width',width).attr('height',height)
      .attr('x',-width/2).attr('y',-height/2)
      .attr('rx',10)
      .attr('fill',TYPE_META[d.type]?.color||'#94a3b8')
      .attr('stroke','#1e293b')
      .attr('stroke-width',1.15);
    lines.forEach((ln,i)=>{
      const maxCharsLine=Math.floor((width-22)/charPx);
      const txt=ln.length>maxCharsLine?ln.slice(0,maxCharsLine-1)+'â€¦':ln;
      g.append('text')
        .attr('text-anchor','middle')
        .attr('y',(-height/2+16)+i*14)
        .attr('font-size',i===0?12:10.5)
        .attr('font-weight',i===0?600:400)
        .attr('fill','#1f2937')
        .text(txt);
    });
  });

  function tick(){
    nodeG.attr('transform',d=>`translate(${d.x},${d.y})`);
    linkPath.attr('d',l=>{
      const s=nodes.find(n=>n.id===l.source)||l.source;
      const t=nodes.find(n=>n.id===l.target)||l.target;
      if(!s||!t) return '';
      const dx=t.x-s.x, dy=t.y-s.y;
      const dr=Math.sqrt(dx*dx+dy*dy)*1.05;
      return `M${s.x},${s.y}A${dr},${dr} 0 0,1 ${t.x},${t.y}`;
    });
    if(edgeLabels){
      edgeLabels
        .attr('x',l=>{
          const s=nodes.find(n=>n.id===l.source)||l.source;
          const t=nodes.find(n=>n.id===l.target)||l.target;
          return (s.x+t.x)/2;
        })
        .attr('y',l=>{
          const s=nodes.find(n=>n.id===l.source)||l.source;
          const t=nodes.find(n=>n.id===l.target)||l.target;
          return (s.y+t.y)/2;
        });
    }
    const pad=60;
    nodes.forEach(n=>{
      n.x=Math.max(pad,Math.min((w-pad),n.x));
      n.y=Math.max(pad,Math.min((h-pad),n.y));
    });
  }

  if(STATE.layoutMode==='force'){
    const sim=d3.forceSimulation(nodes)
      .force('link',d3.forceLink(links).id(d=>d.id).distance(150).strength(.9))
      .force('charge',d3.forceManyBody().strength(-420))
      .force('collide',d3.forceCollide().radius(70))
      .force('center',d3.forceCenter(w/2,h/2))
      .on('tick',tick)
      .on('end',()=>{ fitView(400); });
    STATE.simulation=sim;
  } else if(STATE.layoutMode==='radial'){
    const grouped=TYPE_ORDER.map(t=>nodes.filter(n=>n.type===t)).filter(g=>g.length);
    const cx=w/2, cy=h/2;
    const ringGap=Math.min(w,h)/(2*(grouped.length+1));
    grouped.forEach((arr,i)=>{
      const r=ringGap*(i+1);
      arr.forEach((n,idx)=>{
        const angle=(idx/arr.length)*Math.PI*2;
        n.x=cx+r*Math.cos(angle); n.y=cy+r*Math.sin(angle);
      });
    });
    tick(); STATE.simulation=null;
  } else if(STATE.layoutMode==='grid'){
    const groups=TYPE_ORDER.map(t=>nodes.filter(n=>n.type===t)).filter(g=>g.length);
    let yOff=80;
    groups.forEach(g=>{
      const cols=Math.ceil(Math.sqrt(g.length));
      const cellW=220, cellH=130;
      g.forEach((n,i)=>{
        const col=i%cols, row=(i/cols)|0;
        n.x=140+col*cellW; n.y=yOff+row*cellH;
      });
      yOff+=Math.ceil(g.length/cols)*cellH+90;
    });
    tick(); STATE.simulation=null;
  } else if(STATE.layoutMode==='architecture'){
    const layers=[
      nodes.filter(n=>n.type==='solution'),
      nodes.filter(n=>n.type==='externalsystem'),
      nodes.filter(n=>n.type==='endpoint'),
      nodes.filter(n=>n.type==='connector'),
      nodes.filter(n=>n.type==='dependency'),
      nodes.filter(n=>n.type==='dataflow'),
      nodes.filter(n=>n.type==='kqlfunction'),
      nodes.filter(n=>n.type==='table'),
      nodes.filter(n=>['analyticrule','workbook','huntingquery','playbook','watchlist','notebook'].includes(n.type))
    ].filter(a=>a.length);
    const layerGap=150;
    const startX=140;
    layers.forEach((layerNodes,i)=>{
      const y=120+i*layerGap;
      const cols=Math.max(1,Math.ceil(Math.sqrt(layerNodes.length)));
      const colWidth=220;
      layerNodes.forEach((n,idx)=>{
        const col=idx%cols, row=(idx/cols)|0;
        n.x=startX+col*colWidth;
        n.y=y+row*110;
      });
    });
    tick(); STATE.simulation=null;
  } else {
    tick(); STATE.simulation=null;
  }
  if(!preserve) fitView(0);
}

function highlightNode(id){
  if(!ensureD3())return;
  const nodeSel=d3.select('#zoomLayer').selectAll('.node-group');
  const linkSel=d3.select('#zoomLayer').selectAll('.graph-link');
  if(!id){
    nodeSel.selectAll('rect').attr('opacity',1).attr('stroke-width',1.15);
    linkSel.attr('stroke-opacity',.55).attr('stroke-width',1.3);
    STATE.highlighted=null; return;
  }
  const connected=new Set([id]);
  STATE.graph.links.forEach(l=>{
    if(l.source===id) connected.add(l.target);
    if(l.target===id) connected.add(l.source);
  });
  nodeSel.selectAll('rect')
    .attr('opacity',d=>connected.has(d.id)?1:0.18)
    .attr('stroke-width',d=>d.id===id?3:1.15);
  linkSel
    .attr('stroke-opacity',l=>(l.source===id||l.target===id)?1:0.08)
    .attr('stroke-width',l=>(l.source===id||l.target===id)?3:1.3);
}

/* ================= PANELS ================= */
function buildTypeFilters(){
  const cont=$('#filterTypes'); cont.innerHTML='';
  const present=new Set(STATE.fullGraph.nodes.map(n=>n.type));
  TYPE_ORDER.forEach(t=>{
    if(!present.has(t)) return;
    const label=document.createElement('label');
    label.style.display='flex'; label.style.alignItems='center'; label.style.gap='4px';
    label.innerHTML=`<input type="checkbox" data-type-filter="${t}" checked /> ${(TYPE_META[t]?.label)||t}`;
    cont.appendChild(label);
  });
  $$('[data-type-filter]').forEach(cb=>cb.addEventListener('change',applyFilters));
}
function applyFilters(){
  if(!STATE.fullGraph)return;
  const active=new Set($$('[data-type-filter]:checked').map(cb=>cb.getAttribute('data-type-filter')));
  let nodes=STATE.fullGraph.nodes.filter(n=>active.has(n.type));
  if(!STATE.showIsolated){
    const ids=new Set(nodes.map(n=>n.id));
    const links=STATE.fullGraph.links.filter(l=>ids.has(l.source)&&ids.has(l.target));
    const connected=new Set(); links.forEach(l=>{connected.add(l.source);connected.add(l.target);});
    nodes=nodes.filter(n=>connected.has(n.id)||n.type==='solution');
  }
  const ids=new Set(nodes.map(n=>n.id));
  const links=STATE.fullGraph.links.filter(l=>ids.has(l.source)&&ids.has(l.target));
  STATE.graph={nodes:JSON.parse(JSON.stringify(nodes)),links:JSON.parse(JSON.stringify(links))};
  renderGraph(true);
  if(STATE.highlighted) highlightNode(STATE.highlighted);
  buildLegend();
}
function buildLegend(){
  const div=$('#legend'); div.innerHTML='';
  const present=new Set(STATE.graph.nodes.map(n=>n.type));
  TYPE_ORDER.forEach(t=>{
    if(!present.has(t)) return;
    const row=document.createElement('div');
    row.style.display='flex'; row.style.alignItems='center'; row.style.gap='6px';
    row.innerHTML=`<span style="width:14px;height:14px;border-radius:4px;background:${TYPE_META[t].color};display:inline-block;border:1px solid #1e293b22"></span><span>${TYPE_META[t].label}</span>`;
    div.appendChild(row);
  });
}

function updateSolutionMeta(){
  const el = document.getElementById('solutionMeta');
  const meta = STATE.meta;
  const art = STATE.artifacts;
  const arch = STATE.solutionAnalysis;

  if(!el) return;
  if(!meta || !art){
    el.innerHTML = '<div style="font-size:11px;color:#64748b;">No metadata loaded. Visualize a solution.</div>';
    return;
  }

  // Helper for HTML escaping
  const esc = s => String(s==null?'':s).replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));

  // Build badges
  const badges = [];
  function badge(text, bg, fg='#fff'){ badges.push(`<span class="badge" style="background:${bg};color:${fg};">${esc(text)}</span>`); }

  // Architecture badges
  if(arch){
    const archColor = arch.type === 'CCF' ? '#059669' :
                      arch.type === 'Legacy' ? '#b45309' :
                      '#475569';
    badge(`Architecture: ${arch.type}`, archColor);
    if(arch.ruleMatched) badge(`Rule ${arch.ruleMatched}`, '#334155');
    if(typeof arch.confidence === 'number') badge(`Conf ${arch.confidence}`, '#475569');
    if(arch.ingestionEndpointType && arch.ingestionEndpointType !== 'Unknown')
      badge(`Endpoint: ${arch.ingestionEndpointType}`, '#0d9488');
  } else {
    badge('Architecture: (pending)', '#475569');
  }

  // Categories (solutionMetadata)
  (meta.categories||[]).slice(0,10).forEach(cat=>{
    badge(cat, '#2563eb');
  });

  // Artifact counts summary
  const counts = {
    connectors: art.connectors.length,
    dcrs: art.dcrs.length,
    workbooks: art.workbooks.length,
    analytics: art.analytics.length,
    hunting: art.hunting.length,
    playbooks: art.playbooks.length,
    watchlists: art.watchlists ? art.watchlists.length : 0,
    functions: art.functions ? art.functions.length : 0,
    notebooks: art.notebooks ? art.notebooks.length : 0,
    coreFiles: art.coreFiles.length
  };

  // mainTemplate resource counts (already computed in meta)
  const rc = meta.mainTemplateResourceCounts || {
    total:0,dataConnectors:0,analyticRules:0,workbooks:0,playbooks:0,others:0
  };

  // Ingestion evidence (compact)
  const evidenceBlock = arch?.evidence?.length
    ? esc(arch.evidence.join('; '))
    : 'â€”';

  // Debug block collapsed (only if arch exists)
  let debugHtml = '';
  if(arch?.debug){
    const d = arch.debug;
    debugHtml = `
    <details style="margin-top:6px;">
      <summary style="cursor:pointer;font-size:11px;">Debug Signals</summary>
      <div style="font-size:11px;line-height:1.3;margin-top:4px;">
        <div><b>Resource Kinds:</b> ${esc(d.resourceKinds.join(', ')||'â€”')}</div>
        <div><b>Param Kind Defaults:</b> ${esc(d.paramKinds.join(', ')||'â€”')}</div>
        <div><b>DataConnector Resources:</b> ${d.dataConnectorResourceCount}</div>
        <div><b>DCR Core File:</b> ${d.hasDcrCore}</div>
        <div><b>pollerConfig.json:</b> ${d.hasPollerConfig}</div>
        <div><b>tableSchema.json:</b> ${d.hasTableSchema}</div>
        <div><b>Inline dcrConfig in Connector:</b> ${d.inlineConnectorDcrConfig}</div>
        <div><b>DCE Resource:</b> ${d.hasDceResource}</div>
        <div><b>HTTP Signals:</b> ${d.httpSignals}</div>
        <div><b>Poller Kind Hit:</b> ${d.pollerKindHit}</div>
        <div><b>Legacy Kind Hit:</b> ${d.legacyKindHit}</div>
        <div><b>host.json:</b> ${d.hasHost}</div>
        <div><b>functionApp.json:</b> ${d.hasFunctionApp}</div>
      </div>
    </details>`;
  }

  // Compose HTML
  el.innerHTML = `
    <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px;">${badges.join('')}</div>
    <div style="font-size:12px;line-height:1.35;">
      <div><b>Name:</b> ${esc(meta.solutionName||'(unknown)')}</div>
      <div><b>Solution ID:</b> ${esc(meta.solutionId||'â€”')}</div>
      <div><b>Publisher:</b> ${esc(meta.publisher||'â€”')}</div>
      ${meta.contactEmail ? `<div><b>Contact:</b> ${esc(meta.contactEmail)}</div>`:''}
      <div style="margin-top:6px;"><b>Main Template Resources:</b>
        Total ${rc.total} |
        DC ${rc.dataConnectors} |
        AR ${rc.analyticRules} |
        WB ${rc.workbooks} |
        PB ${rc.playbooks} |
        Other ${rc.others}
      </div>
      <div><b>Artifacts (classified):</b>
        Conn ${counts.connectors} |
        DCR ${counts.dcrs} |
        Wkb ${counts.workbooks} |
        Anl ${counts.analytics} |
        Hunt ${counts.hunting} |
        Ply ${counts.playbooks} |
        Func ${counts.functions} |
        Watch ${counts.watchlists} |
        NB ${counts.notebooks} |
        Core ${counts.coreFiles}
      </div>
      <div style="margin-top:6px;"><b>Architecture Reasoning:</b> ${esc(arch?.reasoning||'â€”')}</div>
      <div><b>Ingestion Evidence:</b> ${evidenceBlock}</div>
      ${debugHtml}
    </div>
  `;
}

function buildDesignOverview(){
  const el=$('#designOverview');
  if(!STATE.artifacts||!STATE.meta){ el.textContent='No data.'; return; }
  const a=STATE.artifacts;
  const tableSet=new Set([
    ...a.connectors.flatMap(c=>c.tables||[]),
    ...a.dcrs.flatMap(d=>d.tables||[]),
    ...a.functions.flatMap(f=>f.tables||[])
  ]);
  const lines=[];
  function entry(label,count,desc){ lines.push(`<div><b>${label}</b> (${count}) â€“ ${desc}</div>`); }
  entry('Data Connectors',a.connectors.length,'Ingestion integration points');
  entry('DCRs',a.dcrs.length,'Data Collection Rules');
  entry('Data Flows', a.dcrs.reduce((sum,d)=>sum+(d.flowsData?d.flowsData.length:0),0)
    + a.coreFiles.filter(c=>c.coreKind==='dcr').reduce((s,c)=>s+(c.flowsData?c.flowsData.length:0),0),'Per DCR flow nodes');
  entry('KQL Functions',a.functions.length,'Reusable logic');
  entry('Tables',tableSet.size,'Target schemas');
  entry('Analytics Rules',a.analytics.length,'Detections');
  entry('Hunting Queries',a.hunting.length,'Investigation queries');
  entry('Workbooks',a.workbooks.length,'Dashboards');
  entry('Playbooks',a.playbooks.length,'Automation');
  entry('Watchlists',a.watchlists.length,'Enrichment lists');
  entry('Notebooks',a.notebooks.length,'Advanced notebooks');
  lines.push('<hr style="border:none;border-top:1px solid var(--panel-border);margin:.4rem 0;">');
  const archType = STATE.solutionAnalysis?.type || 'Unknown';
const archClass = archType === 'CCF'
  ? 'ccf'
  : (archType.startsWith('HTTP') ? 'http' : 'unknown');
lines.push(`
  <div style="margin-top:8px;">
    <span class="arch-highlight ${archClass}">
      Architecture: ${escapeHtml(archType)}
    </span>
  </div>
`);
  el.innerHTML=lines.join('');
}

function showArtifactDetails(node){
  const div=$('#artifactMeta');
  if(!node){ div.textContent='Select a node.'; return; }
  const m=node.meta||{};
  const out=[];
  out.push(`<div style="font-weight:600;margin-bottom:2px;">${TYPE_META[node.type]?.label||node.type}</div>`);
  out.push(`<div><b>ID:</b> ${escapeHtml(node.id)}</div>`);
  if(node.type==='filecore'){
    if(m.coreKind) out.push(`<div><b>Core Kind:</b> ${escapeHtml(m.coreKind)}</div>`);
    if(m.coreKind==='dcr') out.push(`<div><b>DataFlows:</b> ${m.dataFlows||0} Streams:${m.streamCount||0}</div>`);
  }
  if(node.type==='dataflow'){
    out.push(`<div><b>Parent DCR:</b> ${escapeHtml(m.parentDcr||'')}</div>`);
    out.push(`<div><b>Streams:</b> ${escapeHtml((m.streams||[]).join(', ')||'â€”')}</div>`);
    if(m.outputTables?.length) out.push(`<div><b>Outputs:</b> ${escapeHtml(m.outputTables.join(', '))}</div>`);
    out.push(`<div><b>Transform:</b> ${m.hasTransform?`${m.transformLines} lines (${m.transformChars} chars)`:'None'}</div>`);
  }
  if(node.type==='connector'){
    if(m.mechanism) out.push(`<div><b>Mechanism:</b> ${escapeHtml(m.mechanism)}</div>`);
    if(m.kindCategory) out.push(`<div><b>Kind:</b> ${escapeHtml(m.kindCategory)}</div>`);
    if(m.tables?.length) out.push(`<div><b>Tables:</b> ${escapeHtml(m.tables.join(', '))}</div>`);
    if(m.streams?.length) out.push(`<div><b>Streams:</b> ${escapeHtml(m.streams.join(', '))}</div>`);
    if(m.description) out.push(`<div style="margin-top:4px;"><b>Description:</b> ${escapeHtml(m.description.slice(0,600))}${m.description.length>600?'â€¦':''}</div>`);
  }
  if(['workbook','analyticrule','huntingquery'].includes(node.type)){
    if(m.tables?.length) out.push(`<div><b>Tables:</b> ${escapeHtml(m.tables.join(', '))}</div>`);
    if(m.severity) out.push(`<div><b>Severity:</b> ${escapeHtml(m.severity)}</div>`);
    if(m.tactics) out.push(`<div><b>Tactics:</b> ${escapeHtml(m.tactics)}</div>`);
    if(m.queryMetrics) out.push(`<div><b>Query:</b> ${m.queryMetrics.lines} lines (${m.queryMetrics.length} chars)</div>`);
  }
  if(node.type==='kqlfunction'){
    if(m.tables?.length) out.push(`<div><b>Tables:</b> ${escapeHtml(m.tables.join(', '))}</div>`);
    if(m.queryMetrics) out.push(`<div><b>KQL:</b> ${m.queryMetrics.lines} lines (${m.queryMetrics.length} chars)</div>`);
  }
  if(node.type==='playbook') out.push(`<div><b>Triggers:</b> ${m.triggers||0} | Actions: ${m.actions||0}</div>`);
  if(node.type==='notebook' && m.cellCount!=null) out.push(`<div><b>Cells:</b> ${m.cellCount}</div>`);
  if(node.type==='watchlist' && m.description) out.push(`<div><b>Description:</b> ${escapeHtml(m.description)}</div>`);
  if(m.endpoints?.length){
    out.push(`<div><b>Endpoints:</b> ${escapeHtml(m.endpoints.slice(0,12).join(', '))}${m.endpoints.length>12?'â€¦':''}</div>`);
  }
  div.innerHTML=out.join('');
}

function updateLogicPanel(){
  const el=$('#logicPanel');
  const ui=STATE.createUiAnalysis;
  if(!ui){ el.textContent='No createUiDefinition.json'; return; }
  const imp=ui.implied||{};
  el.innerHTML=`
    <div><b>Solution Name:</b> ${escapeHtml(ui.solutionName||'(unknown)')}</div>
    ${ui.description?`<div style="margin-top:2px;">${escapeHtml(ui.description.slice(0,240))}${ui.description.length>240?'â€¦':''}</div>`:''}
    <div style="margin-top:4px;"><b>Implied (keyword counts):</b></div>
    <div>Connectors:${imp.dataConnectors||0} Workbooks:${imp.workbooks||0} Analytics:${imp.analyticRules||0} Hunting:${imp.huntingQueries||0} Playbooks:${imp.playbooks||0}</div>
    <div>Wizard Steps (raw occurrences): ${ui.steps||0}</div>
  `;
}

/* ================= EXPLORER ================= */
let ARTIFACT_SORT={key:'type',asc:true};
function buildArtifactExplorer(){
  const body=$('#artifactTableBody'); body.innerHTML='';
  if(!STATE.artifacts) return;
  const a=STATE.artifacts;
  const list=[
    ...a.coreFiles,...a.connectors,...a.dcrs,...a.workbooks,...a.analytics,
    ...a.hunting,...a.playbooks,...a.watchlists,...a.functions,...a.notebooks,
    ...a.infra,...a.deploy,...a.others
  ].map(x=>({
    type:x.type,
    id:x.id,
    detail:(()=>{
      if(x.type==='filecore'){
        if(x.coreKind==='mainTemplate') return `Res:${x.resourceCounts?.total||0}`;
        if(x.coreKind==='createUiDefinition') return `Steps:${x.stepsCount||0}`;
        if(x.coreKind==='dcr') return `Flows:${x.dataFlows||0}`;
        if(x.coreKind==='pollerConfig') return x.schedule?`Sched:${x.schedule.slice(0,18)}`:'';
        if(x.coreKind==='solutionMetadata') return x.version||'';
        return x.coreKind||'';
      }
      if(x.type==='connector'){
        if(x.mechanism) return x.mechanism;
        if(x.domain) return x.domain;
        return x.kindCategory||'';
      }
      if(x.type==='dependency') return `Flows:${x.dataFlows||0}`;
      if(x.type==='analyticrule') return x.severity||'';
      if(x.type==='playbook') return `T:${x.triggers||0}/A:${x.actions||0}`;
      if(x.type==='kqlfunction') return x.tables?.length?`Tbl:${x.tables.length}`:'Function';
      if(x.type==='watchlist') return x.description? x.description.slice(0,18):'';
      if(x.type==='notebook') return `Cells:${x.cellCount||0}`;
      if(x.type==='deployment') return `Res:${x.resourceCount||0}`;
      if(x.type==='functioninfra') return `Bind:${x.bindingsCount||0}`;
      return '';
    })(),
    tables:(x.tables||[]).slice(0,4).join(',')
  }));
  list.sort((a,b)=>{
    const k=ARTIFACT_SORT.key;
    const av=(a[k]||'').toString().toLowerCase();
    const bv=(b[k]||'').toString().toLowerCase();
    if(av<bv) return ARTIFACT_SORT.asc?-1:1;
    if(av>bv) return ARTIFACT_SORT.asc?1:-1;
    return 0;
  });
  const frag=document.createDocumentFragment();
  list.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${TYPE_META[r.type]?.label||r.type}</td><td>${escapeHtml(r.id)}</td><td>${escapeHtml(r.detail||'')}</td><td>${escapeHtml(r.tables||'')}</td>`;
    tr.addEventListener('click',()=>{
      const node=STATE.fullGraph?.nodes.find(n=>n.id===r.id);
      if(node){ highlightNode(node.id); showArtifactDetails(node); }
    });
    frag.appendChild(tr);
  });
  body.appendChild(frag);
}
function applyArtifactSearch(){
  const term=$('#artifactSearch').value.trim().toLowerCase();
  $$(`#artifactTableBody tr`).forEach(tr=>{
    tr.style.display = tr.textContent.toLowerCase().includes(term)?'':'none';
  });
}
function buildArtifactTypeQuickFilters(){
  const cont=$('#artifactTypeQuick'); cont.innerHTML='';
  TYPE_ORDER.forEach(t=>{
    const btn=document.createElement('button');
    btn.className='btn-muted'; btn.style.fontSize='.55rem';
    btn.textContent=TYPE_META[t].label;
    btn.addEventListener('click',()=>{
      $('#artifactSearch').value='';
      $$(`#artifactTableBody tr`).forEach(tr=>{
        tr.style.display = tr.children[0].textContent===TYPE_META[t].label?'':'none';
      });
    });
    cont.appendChild(btn);
  });
  const all=document.createElement('button');
  all.className='btn-muted'; all.style.fontSize='.55rem';
  all.textContent='All';
  all.addEventListener('click',()=>{
    $('#artifactSearch').value='';
    $$(`#artifactTableBody tr`).forEach(tr=>tr.style.display='');
  });
  cont.appendChild(all);
}

/* ================= EXPORTS ================= */
function exportJson(){
  const obj={meta:STATE.meta,artifacts:STATE.artifacts,graph:STATE.fullGraph,solutionAnalysis:STATE.solutionAnalysis};
  const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='sentinel_graph.json'; a.click(); URL.revokeObjectURL(a.href);
}
function exportCsv(){
  if(!STATE.fullGraph) return;
  const ns=['id,type']; STATE.fullGraph.nodes.forEach(n=>ns.push(`"${n.id.replace(/"/g,'""')}","${n.type}"`));
  const ls=['source,target,edgeType']; STATE.fullGraph.links.forEach(l=>ls.push(`"${l.source}","${l.target}","${l.edgeType}"`));
  const blob=new Blob([ns.join('\n')+'\n\n'+ls.join('\n')],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='sentinel_graph.csv'; a.click(); URL.revokeObjectURL(a.href);
}
function exportPng(){
  if(!ensureD3())return;
  const svgEl=$('#viz');
  const xml=new XMLSerializer().serializeToString(svgEl);
  const canvas=document.createElement('canvas');
  canvas.width=svgEl.clientWidth||1400; canvas.height=svgEl.clientHeight||900;
  const ctx=canvas.getContext('2d');
  const img=new Image();
  img.onload=()=>{
    ctx.fillStyle=document.documentElement.classList.contains('dark')?'#0f172a':'#ffffff';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img,0,0);
    const link=document.createElement('a');
    link.download='sentinel_graph.png';
    link.href=canvas.toDataURL('image/png');
    link.click();
  };
  img.src='data:image/svg+xml;base64,'+btoa(unescape(encodeURIComponent(xml)));
}

/* ================= FETCH & ACTIONS ================= */
async function fetchSolutionFiles(owner,repo,branch,paths,includeNonCore){
  const coreNames=new Set([
    'maintemplate.json','solutionmetadata.json','createuidefinition.json','pollerconfig.json','dcr.json',
    'tableschema.json','host.json','functionapp.json','azuredeploy.json'
  ]);
  const base=`https://raw.githubusercontent.com/${owner}/${repo}/${encodeURIComponent(branch)}/`;
  const out=[];
  for(const p of paths){
    const fileName=p.split('/').pop().toLowerCase();
    const isConnectorCandidate=/connector|dataconnector|data[-_ ]connectors/i.test(p);
    const isCore=coreNames.has(fileName)||includeNonCore||isConnectorCandidate;
    if(!isCore) continue;
    try{
      const js=await fetchJson(base+p,'artifact');
      if(js) out.push({path:p,json:js,core:coreNames.has(fileName)});
    }catch(e){
      log(`Failed fetch ${p}: ${e.message}`,true);
    }
  }
  log(`Fetched ${out.length} JSON files.`);
  return out;
}

async function handleLoadSolutions(){
  try{
    const repoStr=$('#repoInput').value.trim();
    if(!repoStr.includes('/')) return setStatus('Use owner/repo',true);
    let [owner,repo]=repoStr.split('/');
    let branch=$('#branchInput').value.trim();
    if(!branch && CONFIG.ENABLE_BRANCH_AUTODETECT){
      setStatus('Detecting branch...');
      const def=await detectDefaultBranch(owner,repo);
      if(def){ branch=def; $('#branchInput').value=def; }
    }
    if(!branch) branch='master';
    setStatus('Listing solutions...');
    toggleLoader(true,'Listing solutions...');
    const sols=await listSolutions(owner,repo,branch);
    const sel=$('#solutionSelect'); sel.innerHTML='';
    if(!sols.length){ sel.innerHTML='<option value="">(None)</option>'; return setStatus('No solutions found',true); }
    sols.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); });
    setStatus(`Loaded ${sols.length} solutions.`);
  }catch(e){ setStatus(e.message||'Error loading solutions',true); }
  finally{ toggleLoader(false); }
}

async function handleVisualize(){
  if(STATE.fetching) return log('Already running...');
  const repoVal=$('#repoInput').value.trim();
  const branchVal=$('#branchInput').value.trim();
  const solution=$('#solutionSelect').value.trim();
  STATE.includeNonCore=$('#includeNonCore').checked;
  if(!repoVal.includes('/')) return setStatus('owner/repo required',true);
  if(!branchVal) return setStatus('Branch required',true);
  if(!solution) return setStatus('Pick a solution',true);
  const [owner,repo]=repoVal.split('/',2);

  STATE.fetching=true;
  toggleLoader(true);
  setStatus(`Visualizing ${owner}/${repo}@${branchVal}/${solution}`);
  try{
    const paths=await listSolutionJsonPaths(owner,repo,branchVal,solution);
    if(!paths.length) return setStatus('No JSON files found',true);
    const files=await fetchSolutionFiles(owner,repo,branchVal,paths,STATE.includeNonCore);
    if(!files.length) return setStatus('No files fetched',true);
    STATE.artifacts=buildArtifacts(files);
    harvestEmbeddedArtifacts(STATE.artifacts);
     STATE.meta=await extractSolutionMeta(owner,repo,branchVal,solution,paths);
    STATE.solutionAnalysis = analyzeSolutionArchitecture(STATE.artifacts);
    const cuid=files.find(f=>/createuidefinition\.json$/i.test(f.path));
    STATE.createUiAnalysis=cuid?analyzeCreateUiDefinition(cuid.json):null;

    const baseGraph=buildDependencyGraph(STATE.artifacts,STATE.meta.solutionName||solution);
    const archGraph=buildArchitectureGraph(STATE.artifacts,STATE.meta,STATE.solutionAnalysis);
    STATE.fullGraph=(STATE.layoutMode==='architecture')?archGraph:baseGraph;
    STATE.graph=JSON.parse(JSON.stringify(STATE.fullGraph));

    updateSolutionMeta();
    buildDesignOverview();
    updateLogicPanel();
    buildTypeFilters();
    applyFilters();
    buildArtifactExplorer();
    buildArtifactTypeQuickFilters();
    setStatus(`Done. Nodes:${STATE.fullGraph.nodes.length} Links:${STATE.fullGraph.links.length}`);
  }catch(e){
    console.error(e);
    setStatus('Visualization failed: '+(e.message||e),true);
    log('Stack: '+(e.stack||''),true);
  }finally{
    toggleLoader(false);
    STATE.fetching=false;
  }
}

function handleReset(){
  STATE.artifacts=null; STATE.meta=null; STATE.createUiAnalysis=null; STATE.solutionAnalysis=null;
  STATE.fullGraph=null; STATE.graph={nodes:[],links:[]};
  if(ensureD3()) d3.select('#zoomLayer').selectAll('*').remove();
  $('#solutionMeta').textContent='';
  $('#artifactMeta').textContent='Select a node.';
  $('#artifactTableBody').innerHTML='';
  $('#legend').innerHTML='';
  $('#filterTypes').innerHTML='';
  $('#designOverview').textContent='(Visualize to populate.)';
  setStatus('Reset complete.');
}

/* ================= INIT / EVENTS ================= */
function setDarkMode(on){
  document.documentElement.classList.toggle('dark',on);
  STATE.dark=on;
  localStorage.setItem('scv_dark',on?'1':'0');
  $('#btnDark').textContent=on?'Light':'Dark';
  buildLegend();
}

document.addEventListener('DOMContentLoaded',()=>{
  setDarkMode(localStorage.getItem('scv_dark')==='1');
  if(ensureD3()) ZOOM_CTRL=setupZoom(); else setTimeout(()=>{ if(ensureD3()) ZOOM_CTRL=setupZoom(); },600);

  $('#btnLoad').addEventListener('click',handleLoadSolutions);
  $('#btnVisualize').addEventListener('click',handleVisualize);
  $('#btnReset').addEventListener('click',handleReset);
  $('#btnDark').addEventListener('click',()=>setDarkMode(!STATE.dark));

  $('#layoutSelect').addEventListener('change',e=>{
    STATE.layoutMode=e.target.value;
    if(STATE.artifacts){
      const baseGraph=buildDependencyGraph(STATE.artifacts,STATE.meta?.solutionName||'Solution');
      const archGraph=buildArchitectureGraph(STATE.artifacts,STATE.meta,STATE.solutionAnalysis);
      STATE.fullGraph=(STATE.layoutMode==='architecture')?archGraph:baseGraph;
      applyFilters();
      updateSolutionMeta();
      buildDesignOverview();
    }
  });

  $('#degreeScaled').addEventListener('change',()=>{STATE.degreeScaled=$('#degreeScaled').checked;if(STATE.fullGraph)applyFilters();});
  $('#showEdgeLabels').addEventListener('change',()=>{STATE.showEdgeLabels=$('#showEdgeLabels').checked;if(STATE.fullGraph)applyFilters();});

  $('#btnExportJson').addEventListener('click',exportJson);
  $('#btnExportCsv').addEventListener('click',exportCsv);
  $('#btnExportPng').addEventListener('click',exportPng);
  $('#btnRecenter').addEventListener('click',()=>{ if(STATE.simulation) STATE.simulation.alpha(.45).restart(); });
  $('#btnFit').addEventListener('click',()=>fitView());
  $('#btnClearHighlight').addEventListener('click',()=>highlightNode(null));

  $('#zoomIn').addEventListener('click',()=>{
    if(!ensureD3())return;
    const t=STATE.zoom.scale(STATE.zoom.k*1.25);
    d3.select('#viz').transition().duration(260).call(ZOOM_CTRL.transform,t);
    STATE.zoom=t;
  });
  $('#zoomOut').addEventListener('click',()=>{
    if(!ensureD3())return;
    const t=STATE.zoom.scale(STATE.zoom.k*0.8);
    d3.select('#viz').transition().duration(260).call(ZOOM_CTRL.transform,t);
    STATE.zoom=t;
  });
  $('#zoomReset').addEventListener('click',()=>{
    if(!ensureD3())return;
    const t=d3.zoomIdentity;
    d3.select('#viz').transition().duration(400).call(ZOOM_CTRL.transform,t);
    STATE.zoom=t;
  });

  $('#nodeSearch').addEventListener('input',debounce(()=>{
    const v=$('#nodeSearch').value.trim().toLowerCase();
    if(!v){ highlightNode(null); return; }
    const node=STATE.graph.nodes.find(n=>n.id.toLowerCase().includes(v));
    if(node){ highlightNode(node.id); showArtifactDetails(node); }
  },220));

  $('#artifactSearch').addEventListener('input',debounce(applyArtifactSearch,180));
  $$('th[data-sort]').forEach(th=>{
    th.addEventListener('click',()=>{
      const key=th.getAttribute('data-sort');
      if(ARTIFACT_SORT.key===key) ARTIFACT_SORT.asc=!ARTIFACT_SORT.asc;
      else {ARTIFACT_SORT.key=key; ARTIFACT_SORT.asc=true;}
      buildArtifactExplorer(); applyArtifactSearch();
    });
  });

  $('#resetFilters').addEventListener('click',()=>{
    $$('[data-type-filter]').forEach(cb=>cb.checked=true);
    if(STATE.fullGraph) applyFilters();
  });

  window.addEventListener('error',e=>log('GlobalError: '+(e.message||e.error),true));
  window.addEventListener('unhandledrejection',e=>log('UnhandledRejection: '+(e.reason?.message||e.reason),true));

  setStatus('Ready. Load solutions.');
});
document.addEventListener('keydown',e=>{ if(e.key==='Escape') highlightNode(null); });
</script>
</body>
</html>